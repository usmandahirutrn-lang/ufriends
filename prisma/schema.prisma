// Prisma schema for UFriends

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  transactionPin String?
  totpSecret   String?  // TOTP secret for 2FA
  totpEnabled  Boolean  @default(false) // Whether 2FA is enabled
  role         Role     @default(USER)
  isKycVerified Boolean @default(false)
  createdAt    DateTime @default(now())
  profile      Profile?
  wallet       Wallet?
  transactions Transaction[]
  notifications Notification[]
  kycRequests  KycRequest[]
  bvnRequests  BvnRequest[]
  ninRequests  NinRequest[]
  billPayments BillPayment[]
  payments     Payment[]
  posRequests  PosRequest[]
  softwareRequests SoftwareRequest[]
  marketerProfile MarketerProfile?
  enrollments  Enrollment[]
  agents       Agent[]
  refreshTokens RefreshToken[]
  virtualAccount VirtualAccount?
  disputes     Dispute[]
  status       String   @default("active")
}


enum Role {
  USER
  ADMIN
  MARKETER
}

model Profile {
  id        String  @id @default(cuid())
  user      User    @relation(fields: [userId], references: [id])
  userId    String  @unique
  name      String
  phone     String
  avatarUrl String?
  address   String?
}

model KycRequest {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  type        KycType
  status      KycStatus @default(PENDING)
  submittedAt DateTime  @default(now())
  reviewedAt  DateTime?
  documents   Document[]
}

enum KycType {
  BVN
  NIN
  PASSPORT
  VOTER_ID
  DRIVER_LICENSE
  OTHER
}

enum KycStatus {
  PENDING
  APPROVED
  REJECTED
}

model Document {
  id           String    @id @default(cuid())
  kycRequest   KycRequest @relation(fields: [kycRequestId], references: [id])
  kycRequestId String
  type         String
  fileUrl      String
  uploadedAt   DateTime  @default(now())
}

model ServiceCategory {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  services    Service[]
}

model Service {
  id          String          @id @default(cuid())
  category    ServiceCategory @relation(fields: [categoryId], references: [id])
  categoryId  String
  name        String
  slug        String          @unique
  description String?
  active      Boolean         @default(true)
  pricing     ServicePricing[]
}

model ServicePricing {
  id         String  @id @default(cuid())
  service    Service @relation(fields: [serviceId], references: [id])
  serviceId  String
  price      Decimal @db.Decimal(10,2)
  currency   String  @default("NGN")
  tier       String?
  effectiveAt DateTime @default(now())
  parameters  Json?    @default("{}")
}

model BvnRequest {
  id         String   @id @default(cuid())
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  details    Json
  status     RequestStatus @default(PENDING)
  vendorRef  String?
  createdAt  DateTime @default(now())
}

model NinRequest {
  id         String   @id @default(cuid())
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  details    Json
  status     RequestStatus @default(PENDING)
  vendorRef  String?
  createdAt  DateTime @default(now())
}

enum RequestStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model Vendor {
  id     String  @id @default(cuid())
  type   String
  name   String
  config Json
}

model BillPayment {
  id         String   @id @default(cuid())
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  providerId String
  amount     Decimal  @db.Decimal(10,2)
  status     PaymentStatus @default(INIT)
  receiptUrl String?
  createdAt  DateTime @default(now())
}

enum PaymentStatus {
  INIT
  SUCCESS
  FAILED
}

model Wallet {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @unique
  balance   Decimal  @db.Decimal(12,2) @default(0)
  currency  String   @default("NGN")
  updatedAt DateTime @updatedAt
}

model Transaction {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  type      String
  amount    Decimal  @db.Decimal(12,2)
  status    TransactionStatus @default(PENDING)
  reference String   @unique
  meta      Json?
  createdAt DateTime @default(now())

  // Dynamic pricing linkage (optional for legacy transactions)
  category   String?
  subservice String?
  variant    String? @default("")
  amountPaid Decimal? @db.Decimal(12,2)
  basePrice  Decimal? @db.Decimal(12,2)
  profit     Decimal? @db.Decimal(12,2)

  // Admin Manual Processing Fields
  adminNotes String?
  proofUrl   String?

  @@index([status, createdAt])
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
  SUBMITTED
  ONGOING
  REJECTED
  CANCELLED
}

model Payment {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  gateway   String
  amount    Decimal  @db.Decimal(12,2)
  status    PaymentStatus @default(INIT)
  reference String   @unique
  webhookPayload Json?
  createdAt DateTime @default(now())
}

model PosRequest {
  id               String   @id @default(cuid())
  user             User     @relation(fields: [userId], references: [id])
  userId           String
  businessInfo     Json
  status           RequestStatus @default(PENDING)
  assignedAgent    Agent?  @relation(fields: [assignedAgentId], references: [id])
  assignedAgentId  String?
  createdAt        DateTime @default(now())
}

model Agent {
  id       String @id @default(cuid())
  user     User?  @relation(fields: [userId], references: [id])
  userId   String?
  level    String?
  location String?
  active   Boolean @default(true)
  assignedPosRequests PosRequest[]
}

model SoftwareRequest {
  id            String   @id @default(cuid())
  user          User     @relation(fields: [userId], references: [id])
  userId        String
  serviceType   String
  subType       String
  formJson      Json
  price         Decimal  @db.Decimal(12,2)
  status        RequestStatus @default(PENDING)
  submittedAt   DateTime @default(now())
  assignment    Assignment?
  deliveryFiles DeliveryFile[]
}

model Assignment {
  id             String           @id @default(cuid())
  request        SoftwareRequest  @relation(fields: [requestId], references: [id])
  requestId      String           @unique
  developerName  String
  contact        String?
  expectedCompletion DateTime
  assignedBy     String
  assignedAt     DateTime @default(now())
  status         String   @default("Assigned")
}

model DeliveryFile {
  id        String          @id @default(cuid())
  request   SoftwareRequest @relation(fields: [requestId], references: [id])
  requestId String
  fileUrl   String
  uploadedAt DateTime @default(now())
  note      String?
}

model MarketerProfile {
  id                  String   @id @default(cuid())
  user                User     @relation(fields: [userId], references: [id])
  userId              String   @unique
  referralCode        String   @unique
  status              String   @default("Pending") // Pending, Approved, Rejected, Suspended
  state               String?
  lga                 String?
  marketingType       String[] // Array of strings: "pos", "airtime-data", etc.
  passportUrl         String?
  validIdUrl          String?
  commissionBalance   Decimal  @default(0) @db.Decimal(12, 2)
  totalCommission     Decimal  @default(0) @db.Decimal(12, 2)
  totalSales          Decimal  @default(0) @db.Decimal(12, 2)
  totalReferrals      Int      @default(0)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model TrainingSession {
  id           String   @id @default(cuid())
  title        String
  schedule     DateTime
  materialsUrl String?
  capacity     Int?
  status       String   @default("Active")
  enrollments  Enrollment[]
}

model Enrollment {
  id               String          @id @default(cuid())
  user             User            @relation(fields: [userId], references: [id])
  userId           String
  trainingSession  TrainingSession @relation(fields: [trainingSessionId], references: [id])
  trainingSessionId String
  status           String @default("Enrolled")
}

model Notification {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  type      String
  title     String
  body      String
  readAt    DateTime?
  createdAt DateTime @default(now())
}

model SystemSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  valueJson Json
  updatedAt DateTime @updatedAt
}

// Service Catalog: central registry for categories, subservices, and variants
model ServiceCatalog {
  id          Int      @id @default(autoincrement())
  category    String
  subservice  String
  variant     String   @default("")
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  parameters  Json?    @default("{}")

  @@unique([category, subservice, variant], name: "category_subservice_variant_unique")
}

// Pricing tied to ServiceCatalog by (category, subservice, variant)
model CatalogPricing {
  id            Int      @id @default(autoincrement())
  category      String
  subservice    String
  variant       String   @default("")
  basePrice     Decimal  @db.Decimal(10,2)
  userPrice     Decimal  @db.Decimal(10,2)
  marketerPrice Decimal  @db.Decimal(10,2)
  updatedBy     String?
  updatedAt     DateTime @updatedAt
  // Dynamic parameters for variant differentiation (e.g., network, quantity, type)
  parameters    Json?    @default("{}")
  // Stable key identifying a parameter combination (sorted key=value pairs)
  paramsKey     String   @default("")

  @@unique([category, subservice, variant, paramsKey], name: "catalog_pricing_category_subservice_variant_paramsKey_unique")
  @@map("service_pricing")
}

model ApiSettings {
  id        String   @id @default(cuid())
  provider  String   @unique
  configJson Json
  updatedAt DateTime @updatedAt
}

model AuditLog {
  id           String   @id @default(cuid())
  actorId      String?
  action       String
  resourceType String
  resourceId   String?
  diffJson     Json?
  createdAt    DateTime @default(now())
}

model OtpCode {
  id         String   @id @default(cuid())
  email      String?
  phone      String?
  code       String
  purpose    String   @default("signup")
  expiresAt  DateTime
  consumedAt DateTime?
  attempts   Int      @default(0)
  ip         String?
  createdAt  DateTime @default(now())

  @@index([email, purpose])
  @@index([phone, purpose])
}

model RefreshToken {
  id         String   @id @default(cuid())
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  tokenId    String   @unique
  expiresAt  DateTime
  revokedAt  DateTime?
  ip         String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId])
}

model VirtualAccount {
  id            String   @id @default(cuid())
  user          User     @relation(fields: [userId], references: [id])
  userId        String   @unique
  accountNumber String   @unique
  bankName      String   @default("Moniepoint Microfinance Bank")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model ServiceProvider {
  id           String   @id @default(cuid())
  name         String   @unique
  category     String   // airtime, data, bills, bvn, nin, cac, etc.
  isActive     Boolean  @default(false)
  priority     Int      @default(0) // Higher priority = preferred provider
  apiBaseUrl   String?
  configJson   Json?    // Provider-specific configuration
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // API credentials (encrypted)
  apiKeys      ProviderApiKey[]
  
  @@index([category, isActive, priority])
}

model ProviderApiKey {
  id         String          @id @default(cuid())
  provider   ServiceProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  providerId String
  keyName    String          // e.g., "api_key", "secret_key", "merchant_id"
  keyValue   String          // Encrypted value
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  
  @@unique([providerId, keyName])
}

model NinTemplate {
  id              String   @id @default(cuid())
  name            String
  type            String   // "digital", "physical", "nims"
  templateContent String   // HTML template with placeholders
  placeholders    String[] // Array of placeholder strings like "{{firstName}}"
  isActive        Boolean  @default(true)
  createdBy       String   // User ID who created the template
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([type, isActive])
}
model Dispute {
  id            String   @id @default(cuid())
  user          User     @relation(fields: [userId], references: [id])
  userId        String
  reference     String?  // Optional transaction reference
  service       String   // e.g., "BVN", "NIN", "Wallet"
  issue         String   // Description of the issue
  status        DisputeStatus @default(OPEN)
  adminNotes    String?
  screenshotUrl String?
  assignedTo    String?  // Admin ID or Name
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

enum DisputeStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  ESCALATED
  CLOSED
}
