{"version":3,"sources":["turbopack:///[project]/lib/kyc-check.ts"],"sourcesContent":["import { prisma } from \"@/lib/db\"\r\nimport { NextResponse } from \"next/server\"\r\n\r\n/**\r\n * Checks if a user has an approved KYC.\r\n * Returns null if verified, or a NextResponse error if blocked.\r\n */\r\nexport async function ensureKyc(userId: string) {\r\n    const user = await prisma.user.findUnique({\r\n        where: { id: userId },\r\n        select: { isKycVerified: true } as any,\r\n    }) as any\r\n\r\n    // If already flagged in user model, we are good\r\n    if (user?.isKycVerified) {\r\n        return null\r\n    }\r\n\r\n    // Fallback: Check if there's an APPROVED kycRequest (in case flag is out of sync)\r\n    const approvedKyc = await prisma.kycRequest.findFirst({\r\n        where: { userId, status: \"APPROVED\" },\r\n    })\r\n\r\n    if (approvedKyc) {\r\n        // Self-heal: Update the flag if it was false but an approved request exists\r\n        await prisma.user.update({\r\n            where: { id: userId },\r\n            data: { isKycVerified: true } as any,\r\n        })\r\n        return null\r\n    }\r\n\r\n    return NextResponse.json(\r\n        {\r\n            error: \"KYC Required\",\r\n            message: \"Please complete your KYC verification to access this service.\",\r\n            code: \"KYC_REQUIRED\",\r\n        },\r\n        { status: 403 }\r\n    )\r\n}\r\n"],"names":[],"mappings":"wCAAA,IAAA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,OAMO,eAAe,EAAU,CAAc,EAC1C,IAAM,EAAO,MAAM,EAAA,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,CACtC,MAAO,CAAE,GAAI,CAAO,EACpB,OAAQ,CAAE,eAAe,CAAK,CAClC,UAGA,AAAI,GAAM,cACC,CADc,IAKL,MAAM,EAAA,MAAM,CAAC,UAAU,CAAC,SAAS,CAAC,CAClD,MAAO,QAAE,EAAQ,OAAQ,UAAW,CACxC,IAII,MAAM,EAAA,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,CACrB,MAAO,CAAE,GAAI,CAAO,EACpB,KAAM,CAAE,eAAe,CAAK,CAChC,GACO,MAGJ,EAAA,YAAY,CAAC,IAAI,CACpB,CACI,MAAO,eACP,QAAS,gEACT,KAAM,cACV,EACA,CAAE,OAAQ,GAAI,EAEtB"}