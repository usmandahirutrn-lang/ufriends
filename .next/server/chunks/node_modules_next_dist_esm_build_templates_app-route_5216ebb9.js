module.exports=[413742,e=>{"use strict";var r=e.i(747909),a=e.i(174017),t=e.i(996250),i=e.i(759756),n=e.i(561916),o=e.i(114444),s=e.i(837092),d=e.i(869741),c=e.i(316795),u=e.i(487718),p=e.i(995169),l=e.i(47587),m=e.i(666012),f=e.i(570101),g=e.i(626937),v=e.i(10372),R=e.i(193695);e.i(52474);var E=e.i(600220),S=e.i(89171),I=e.i(762294),w=e.i(909438),h=e.i(67675),N=e.i(322632),C=e.i(506363),b=e.i(363190),k=e.i(848598),T=e.i(174717),_=e.i(943227),y=e.i(74567),A=e.i(796255),U=e.i(554271);async function P(e,r){let a=r?.apiBaseUrl||process.env.SUBANDGAIN_BASE_URL||"https://subandgain.com",t=(r?.apiKeys||[]).find(e=>"apikey"===e.keyName.toLowerCase())?.keyValue||process.env.SUBANDGAIN_API_KEY||"",i=r?.configJson?.endpoints?.cable||"/cable/purchase",n=`${a}${i}`;if(!a||!t)return{ok:!1,code:"MISSING_CONFIG",message:"Missing provider base URL or API key"};if(!e.params?.smartcardNumber||!e.params?.provider||!e.params?.planId)return{ok:!1,code:"BAD_INPUT",message:"Missing smartcard number, provider, or plan ID"};try{let r={smartcardNumber:e.params.smartcardNumber,provider:e.params.provider,plan:e.params.planId,amount:e.amount,customerName:e.params.customerName},{res:a,data:i}=await (0,U.fetchJsonWithRetry)(n,{method:"POST",headers:(0,U.buildAuthHeaders)(t),body:JSON.stringify(r)},{retries:3,baseDelayMs:400,timeoutMs:1e4});if(!a.ok){let e=i?.error||"PROVIDER_ERROR",r=i?.message||i?.error||`Provider error (${a.status})`;return{ok:!1,code:e||i?.code||"PROVIDER_ERROR",message:r}}let o=i?.reference||i?.providerRef||i?.transactionId;if(!o)return{ok:!1,code:"NO_REFERENCE",message:"Missing provider reference"};return{ok:!0,providerReference:o,message:i?.message||"Cable subscription successful"}}catch(e){return{ok:!1,code:"NETWORK_ERROR",message:String(e)}}}async function x(e,r){let a=r?.apiBaseUrl||process.env.PREMBLY_BASE_URL||"https://api.prembly.com",t=(r?.apiKeys||[]).find(e=>"api_key"===e.keyName.toLowerCase())?.keyValue||process.env.PREMBLY_API_KEY||"",i=(r?.apiKeys||[]).find(e=>"app_id"===e.keyName.toLowerCase())?.keyValue||process.env.PREMBLY_APP_ID||"",n=r?.configJson?.endpoints?.nin||"/verification/nin/advanced";if(!a||!t||!i)return{ok:!1,code:"MISSING_CONFIG",message:"Missing provider base URL, API key, or app id"};if(!e.nin||11!==e.nin.length)return{ok:!1,code:"BAD_INPUT",message:"Invalid NIN format. NIN must be 11 digits"};let o={nin:e.nin,phone:e.phone,firstName:e.firstName,lastName:e.lastName,dateOfBirth:e.dateOfBirth,gender:e.gender},s=null;for(let r of[n,"/verification/nin/advanced","/verification/nin/printout","/verification/nin","/v1/verifications/identity/nin/advanced","/v1/verifications/identity/nin/printout","/v1/verifications/identity/nin","/v1/verifications/identities/nin/printout"]){let n=`${a}${r}`;try{let{res:a,data:d}=await (0,U.fetchJsonWithRetry)(n,{method:"POST",headers:(0,U.buildAuthHeaders)(t,{Accept:"application/json","app-id":i}),body:JSON.stringify(o)},{retries:2,baseDelayMs:400,timeoutMs:12e3});if(!a.ok){let e=d?.message||d?.error||a.statusText||"Unknown error",t={ok:!1,code:`HTTP_${a.status}`,message:`Prembly API error: ${a.status} ${e} (endpoint: ${r})`};if(404===a.status){s=t;continue}return t}if(d?.status==="success"||d?.success===!0||d?.status===!0)return{ok:!0,data:{nin:d.data?.nin||e.nin,firstName:d.data?.firstName||d.data?.first_name||"",lastName:d.data?.lastName||d.data?.last_name||"",middleName:d.data?.middleName||d.data?.middle_name||"",dateOfBirth:d.data?.dateOfBirth||d.data?.date_of_birth||"",gender:d.data?.gender||"",phone:d.data?.phone||d.data?.phoneNumber||"",address:d.data?.address||"",photo:d.data?.photo||d.data?.image||"",trackingId:d.data?.trackingId||d.data?.tracking_id||"",issueDate:d.data?.issueDate||d.data?.issue_date||"",signature:d.data?.signature||"",stateOfOrigin:d.data?.stateOfOrigin||d.data?.state_of_origin||"",lga:d.data?.lga||"",maritalStatus:d.data?.maritalStatus||d.data?.marital_status||"",profession:d.data?.profession||"",religion:d.data?.religion||"",bloodGroup:d.data?.bloodGroup||d.data?.blood_group||"",height:d.data?.height||"",nextOfKin:d.data?.nextOfKin||d.data?.next_of_kin||"",nextOfKinPhone:d.data?.nextOfKinPhone||d.data?.next_of_kin_phone||"",nextOfKinAddress:d.data?.nextOfKinAddress||d.data?.next_of_kin_address||""},reference:d.reference||d.transactionId,transactionId:d.transactionId||d.reference};return{ok:!1,code:d?.code||"VERIFICATION_FAILED",message:d?.message||d?.error||"NIN verification failed"}}catch(e){s={ok:!1,code:"NETWORK_ERROR",message:`Network error on ${r}: ${String(e)}`};continue}}return s||{ok:!1,code:"UNKNOWN_ERROR",message:"NIN verification failed for unknown reasons"}}var L=e.i(612834),O=e.i(447150);async function D(r,a){try{let t=await (0,w.requireAuth)(r);if(!t.ok)return t.response;if(!(await (0,h.protect)(r)).allowed)return S.NextResponse.json({error:"Forbidden"},{status:403});let{category:i,action:n}=await a.params,o=decodeURIComponent(i),s=decodeURIComponent(n),d=await r.json(),c=N.z.object({amount:N.z.number().positive(),idempotencyKey:N.z.string().min(8).optional(),params:N.z.record(N.z.any()).default({}),subServiceId:N.z.string().optional(),pin:N.z.string().length(4).regex(/^\d+$/)}).safeParse(d);if(!c.success)return S.NextResponse.json({error:"Invalid request",detail:c.error.flatten()},{status:400});let{amount:u,idempotencyKey:p,params:l,subServiceId:m,pin:f}=c.data,g=p||`SRV-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,v=await I.prisma.user.findUnique({where:{id:t.user.id},select:{transactionPin:!0}});if(!v?.transactionPin)return S.NextResponse.json({error:"Transaction PIN not set"},{status:403});let{compare:R}=await e.A(379546);if(!await R(f||"",v.transactionPin))return S.NextResponse.json({error:"Invalid transaction PIN"},{status:401});if(!["airtime","data","bills","education"].includes(o.toLowerCase())){let{ensureKyc:r}=await e.A(278929),a=await r(t.user.id);if(a)return a}if((0,O.isManualService)(o,s)){let e=await I.prisma.wallet.findUnique({where:{userId:t.user.id}});if(!e||Number(e.balance)<u)return S.NextResponse.json({error:"Insufficient wallet balance"},{status:402});return await I.prisma.$transaction([I.prisma.transaction.create({data:{userId:t.user.id,type:"SERVICE_REQUEST",amount:u,status:"SUBMITTED",reference:g,category:o,subservice:s,meta:{serviceId:o,action:s,subServiceId:m,params:l,manual:!0}}}),I.prisma.wallet.update({where:{userId:t.user.id},data:{balance:{decrement:u}}}),I.prisma.auditLog.create({data:{actorId:t.user.id,action:"MANUAL_SERVICE_REQUEST",resourceType:"Transaction",resourceId:g,diffJson:{amount:u,serviceId:o,action:s,subServiceId:m,params:l,status:"SUBMITTED"}}})]),S.NextResponse.json({ok:!0,reference:g,status:"SUBMITTED",message:"Service request submitted. Admin will review shortly."})}let E=await I.prisma.transaction.findUnique({where:{reference:g}}).catch(()=>null);if(E)return S.NextResponse.json({ok:!0,idempotent:!0,reference:g,transaction:E});if("nin"===o.toLowerCase()&&["slip","printout","advanced"].includes(s.toLowerCase())){let e=await I.prisma.wallet.findUnique({where:{userId:t.user.id}});if(!e||Number(e.balance)<u)return S.NextResponse.json({error:"Insufficient wallet balance"},{status:402});return await I.prisma.$transaction([I.prisma.transaction.create({data:{userId:t.user.id,type:"SERVICE_PURCHASE",amount:u,status:"PENDING",reference:g,category:o,subservice:s,meta:{serviceId:o,subServiceId:m,action:s,params:l}}}),I.prisma.auditLog.create({data:{actorId:t.user.id,action:"SERVICE_REQUEST_INIT",resourceType:"Transaction",resourceId:g,diffJson:{amount:u,serviceId:o,action:s,subServiceId:m,params:l}}})]),await I.prisma.$transaction([I.prisma.transaction.update({where:{reference:g},data:{status:"SUCCESS",meta:{slip:"nin",variant:m}}}),I.prisma.wallet.update({where:{userId:t.user.id},data:{balance:{decrement:u}}}),I.prisma.auditLog.create({data:{actorId:t.user.id,action:"SERVICE_REQUEST_SUCCESS",resourceType:"Transaction",resourceId:g,diffJson:{amount:u,serviceId:o,action:s,subServiceId:m,params:l}}})]),S.NextResponse.json({ok:!0,reference:g})}if("bvn"===o.toLowerCase()){let e=await I.prisma.wallet.findUnique({where:{userId:t.user.id}});if(!e||Number(e.balance)<u)return S.NextResponse.json({error:"Insufficient wallet balance"},{status:402});let r=(0,L.default)(),a=null;try{if("printout"===s.toLowerCase())a=await r.getBVNPrintout({bvn:String(l?.bvn||"")});else if("advanced"===s.toLowerCase())a=await r.getBVNAdvanced({bvn:String(l?.bvn||"")});else{if("retrieval_phone"!==s.toLowerCase())return S.NextResponse.json({error:`Unsupported BVN action: ${s}`},{status:400});a=await r.getBVNByPhone({phoneNumber:String(l?.phoneNumber||"")})}}catch(e){a={status:!1,error:e?.message||String(e),detail:e?.message||String(e)}}if(!a?.status)return await I.prisma.$transaction([I.prisma.transaction.create({data:{userId:t.user.id,type:"SERVICE_PURCHASE",amount:u,status:"FAILED",reference:g,category:o,subservice:s,meta:{serviceId:o,action:s,params:l,error:a?.error||a?.detail}}}),I.prisma.auditLog.create({data:{actorId:t.user.id,action:"SERVICE_REQUEST_FAILED",resourceType:"Transaction",resourceId:g,diffJson:{amount:u,serviceId:o,action:s,reason:a?.error||a?.detail,params:l}}})]),S.NextResponse.json({ok:!1,reference:g,error:a?.error||a?.detail||"BVN request failed"},{status:400});return await I.prisma.$transaction([I.prisma.transaction.create({data:{userId:t.user.id,type:"SERVICE_PURCHASE",amount:u,status:"SUCCESS",reference:g,category:o,subservice:s,meta:{serviceId:o,action:s,params:l}}}),I.prisma.wallet.update({where:{userId:t.user.id},data:{balance:{decrement:u}}}),I.prisma.auditLog.create({data:{actorId:t.user.id,action:"SERVICE_REQUEST_SUCCESS",resourceType:"Transaction",resourceId:g,diffJson:{amount:u,serviceId:o,action:s,params:l}}})]),S.NextResponse.json({ok:!0,reference:g,data:a?.data})}let U=await (0,C.getActiveProvider)(o);if(!U.provider)return S.NextResponse.json({error:"No active provider for service",serviceId:o,fallbackProviders:U.fallbackProviders},{status:503});let D=await I.prisma.wallet.findUnique({where:{userId:t.user.id}});if(!D||Number(D.balance)<u)return S.NextResponse.json({error:"Insufficient wallet balance"},{status:402});if(await I.prisma.$transaction([I.prisma.transaction.create({data:{userId:t.user.id,type:"SERVICE_PURCHASE",amount:u,status:"PENDING",reference:g,category:o,subservice:m||s,meta:{serviceId:o,subServiceId:m,action:s,providerId:U.provider.id,params:l}}}),I.prisma.auditLog.create({data:{actorId:t.user.id,action:"SERVICE_REQUEST_INIT",resourceType:"Transaction",resourceId:g,diffJson:{amount:u,serviceId:o,action:s,subServiceId:m,providerId:U.provider.id,params:l}}})]),"airtime"===o&&"vtu"===s){let e=String(U.provider.configJson?.adapter||"").toLowerCase(),r=U.provider.name.toLowerCase(),a=e.includes("subandgain")||r.includes("subandgain"),i=e.includes("ported")||r.includes("ported"),n=e.includes("mock")||r.includes("mock"),d=a?await (0,k.sendAirtimeViaSubAndGain)({amount:u,params:{phone:String(l?.phone||""),network:String(l?.network||"")},providerId:U.provider.id,subServiceId:m},U.provider):i?await (0,b.sendAirtimeViaPorted)({amount:u,params:{phone:String(l?.phone||""),network:String(l?.network||"")},providerId:U.provider.id,subServiceId:m},U.provider):n?{ok:!0,providerReference:`mock_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,message:"Mock airtime purchase successful"}:{ok:!1,code:"UNSUPPORTED_ADAPTER",message:"Unsupported airtime adapter (expected subandgain, ported, or mock)"},c=U.provider;if(!d.ok&&U.fallbackProviders.length>0)for(let e of U.fallbackProviders){let r=String(e.configJson?.adapter||e.name||"").toLowerCase(),a=r.includes("ported")||r.includes("portedsim"),i=r.includes("subandgain");if("airtime"!==e.category||!a&&!i)continue;await I.prisma.auditLog.create({data:{actorId:t.user.id,action:"SERVICE_FAILOVER_ATTEMPT",resourceType:"Transaction",resourceId:g,diffJson:{fromProviderId:c?.id,toProviderId:e.id,category:o}}});let n=a?await (0,b.sendAirtimeViaPorted)({amount:u,params:{phone:String(l?.phone||""),network:String(l?.network||"")},providerId:e.id,subServiceId:m},e):await (0,k.sendAirtimeViaSubAndGain)({amount:u,params:{phone:String(l?.phone||""),network:String(l?.network||"")},providerId:e.id,subServiceId:m},e);if(n.ok){d=n,c=e;break}}if(!d.ok)return await I.prisma.$transaction([I.prisma.transaction.update({where:{reference:g},data:{status:"FAILED",meta:{error:d.message,code:d.code}}}),I.prisma.auditLog.create({data:{actorId:t.user.id,action:"SERVICE_REQUEST_FAILED",resourceType:"Transaction",resourceId:g,diffJson:{amount:u,serviceId:o,action:s,subServiceId:m,reason:d.message,code:d.code,params:l}}})]),S.NextResponse.json({ok:!1,reference:g,error:d.message,code:d.code},{status:400});return await I.prisma.$transaction([I.prisma.transaction.update({where:{reference:g},data:{status:"SUCCESS",meta:{providerRef:d.providerReference,providerId:c?.id}}}),I.prisma.wallet.update({where:{userId:t.user.id},data:{balance:{decrement:u}}}),I.prisma.auditLog.create({data:{actorId:t.user.id,action:"SERVICE_REQUEST_SUCCESS",resourceType:"Transaction",resourceId:g,diffJson:{amount:u,serviceId:o,action:s,subServiceId:m,providerRef:d.providerReference,providerId:c?.id}}})]),S.NextResponse.json({ok:!0,reference:g,provider:c,providerRef:d.providerReference})}if("data"===o&&"bundle"===s){let e=String(U.provider.configJson?.adapter||"").toLowerCase(),r=U.provider.name.toLowerCase(),a=e.includes("subandgain")||r.includes("subandgain"),i=e.includes("ported")||r.includes("ported"),n=a?await (0,_.sendDataBundleViaSubAndGain)({amount:u,params:{phone:String(l?.phone||""),network:String(l?.network||""),planCode:String(l?.planCode||"")},providerId:U.provider.id,subServiceId:m},U.provider):i?await (0,T.sendDataBundleViaPorted)({amount:u,params:{phone:String(l?.phone||""),network:String(l?.network||""),planCode:String(l?.planCode||"")},providerId:U.provider.id,subServiceId:m},U.provider):{ok:!1,code:"UNSUPPORTED_ADAPTER",message:"Unsupported data adapter (expected subandgain or ported)"},d=U.provider;if(!n.ok&&U.fallbackProviders.length>0)for(let e of U.fallbackProviders){let r=String(e.configJson?.adapter||e.name||"").toLowerCase(),a=r.includes("ported")||r.includes("portedsim"),i=r.includes("subandgain");if("data"!==e.category||!a&&!i)continue;await I.prisma.auditLog.create({data:{actorId:t.user.id,action:"SERVICE_FAILOVER_ATTEMPT",resourceType:"Transaction",resourceId:g,diffJson:{fromProviderId:d?.id,toProviderId:e.id,category:o}}});let s=a?await (0,T.sendDataBundleViaPorted)({amount:u,params:{phone:String(l?.phone||""),network:String(l?.network||""),planCode:String(l?.planCode||"")},providerId:e.id,subServiceId:m},e):await (0,_.sendDataBundleViaSubAndGain)({amount:u,params:{phone:String(l?.phone||""),network:String(l?.network||""),planCode:String(l?.planCode||"")},providerId:e.id,subServiceId:m},e);if(s.ok){n=s,d=e;break}}if(!n.ok)return await I.prisma.$transaction([I.prisma.transaction.update({where:{reference:g},data:{status:"FAILED",meta:{error:n.message,code:n.code}}}),I.prisma.auditLog.create({data:{actorId:t.user.id,action:"SERVICE_REQUEST_FAILED",resourceType:"Transaction",resourceId:g,diffJson:{amount:u,serviceId:o,action:s,subServiceId:m,reason:n.message,code:n.code,params:l}}})]),S.NextResponse.json({ok:!1,reference:g,error:n.message,code:n.code},{status:400});return await I.prisma.$transaction([I.prisma.transaction.update({where:{reference:g},data:{status:"SUCCESS",meta:{providerRef:n.providerReference,providerId:d?.id}}}),I.prisma.wallet.update({where:{userId:t.user.id},data:{balance:{decrement:u}}}),I.prisma.auditLog.create({data:{actorId:t.user.id,action:"SERVICE_REQUEST_SUCCESS",resourceType:"Transaction",resourceId:g,diffJson:{amount:u,serviceId:o,action:s,subServiceId:m,providerRef:n.providerReference,providerId:d?.id}}})]),S.NextResponse.json({ok:!0,reference:g,provider:d,providerRef:n.providerReference})}if("bills"===o&&"electricity"===s){let e=String(U.provider.configJson?.adapter||"").toLowerCase(),r=U.provider.name.toLowerCase(),a=e.includes("subandgain")||r.includes("subandgain")?await (0,y.payBillViaSubAndGain)({amount:u,params:{meterNumber:String(l?.meterNumber||""),serviceProvider:String(l?.serviceProvider||""),customerName:String(l?.customerName||""),customerAddress:String(l?.customerAddress||"")},providerId:U.provider.id,subServiceId:m},U.provider):{ok:!1,code:"UNSUPPORTED_ADAPTER",message:"Unsupported bills adapter (expected subandgain)"};if(!a.ok)return await I.prisma.$transaction([I.prisma.transaction.update({where:{reference:g},data:{status:"FAILED",meta:{error:a.message,code:a.code}}}),I.prisma.auditLog.create({data:{actorId:t.user.id,action:"SERVICE_REQUEST_FAILED",resourceType:"Transaction",resourceId:g,diffJson:{amount:u,serviceId:o,action:s,subServiceId:m,reason:a.message,code:a.code,params:l}}})]),S.NextResponse.json({ok:!1,reference:g,error:a.message,code:a.code},{status:400});return await I.prisma.$transaction([I.prisma.transaction.update({where:{reference:g},data:{status:"SUCCESS",meta:{providerRef:a.providerReference,token:a.token,units:a.units}}}),I.prisma.wallet.update({where:{userId:t.user.id},data:{balance:{decrement:u}}}),I.prisma.auditLog.create({data:{actorId:t.user.id,action:"SERVICE_REQUEST_SUCCESS",resourceType:"Transaction",resourceId:g,diffJson:{amount:u,serviceId:o,action:s,subServiceId:m,providerRef:a.providerReference,token:a.token,units:a.units,params:l}}})]),S.NextResponse.json({ok:!0,reference:g,provider:U.provider,providerRef:a.providerReference,token:a.token,units:a.units})}if("bills"===o&&"cable"===s){let e=String(U.provider.configJson?.adapter||"").toLowerCase(),r=U.provider.name.toLowerCase(),a=e.includes("subandgain")||r.includes("subandgain")?await P({amount:u,params:{smartcardNumber:String(l?.smartcardNumber||""),provider:String(l?.provider||""),planId:String(l?.planId||""),customerName:String(l?.customerName||"")},providerId:U.provider.id,subServiceId:m},U.provider):{ok:!1,code:"UNSUPPORTED_ADAPTER",message:"Unsupported cable adapter (expected subandgain)"};if(!a.ok)return await I.prisma.$transaction([I.prisma.transaction.update({where:{reference:g},data:{status:"FAILED",meta:{error:a.message,code:a.code}}}),I.prisma.auditLog.create({data:{actorId:t.user.id,action:"SERVICE_REQUEST_FAILED",resourceType:"Transaction",resourceId:g,diffJson:{amount:u,serviceId:o,action:s,subServiceId:m,reason:a.message,code:a.code,params:l}}})]),S.NextResponse.json({ok:!1,reference:g,error:a.message,code:a.code},{status:400});return await I.prisma.$transaction([I.prisma.transaction.update({where:{reference:g},data:{status:"SUCCESS",meta:{providerRef:a.providerReference}}}),I.prisma.wallet.update({where:{userId:t.user.id},data:{balance:{decrement:u}}}),I.prisma.auditLog.create({data:{actorId:t.user.id,action:"SERVICE_REQUEST_SUCCESS",resourceType:"Transaction",resourceId:g,diffJson:{amount:u,serviceId:o,action:s,subServiceId:m,providerRef:a.providerReference,params:l}}})]),S.NextResponse.json({ok:!0,reference:g,provider:U.provider,providerRef:a.providerReference})}if("education"===o){let e=String(U.provider.configJson?.adapter||"").toLowerCase(),r=U.provider.name.toLowerCase(),a=e.includes("subandgain")||r.includes("subandgain"),i=e.includes("mock")||r.includes("mock"),n={neco:"NECO",waec:"WAEC",nabteb:"NABTEB",nbais:"NBAIS",token:String(l?.eduType||"")},d=String(l?.eduType||"").trim().toUpperCase(),c="";c=d?d.includes("WAEC")||d.includes("GCE")?"WAEC":d.includes("NECO")?"NECO":d.includes("NABTEB")?"NABTEB":d.includes("NBAIS")?"NBAIS":d:n[s]||"";let p=a?await (0,A.payEducationViaSubAndGain)({amount:u,params:{eduType:c},providerId:U.provider.id,subServiceId:m},U.provider):i?{ok:!0,providerReference:`mock_edu_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,token:`EDU-${c||"TOKEN"}-${Math.random().toString(36).substr(2,8).toUpperCase()}`,message:`Mock education token purchase successful for ${c||"education service"}`}:{ok:!1,code:"UNSUPPORTED_ADAPTER",message:"Unsupported education adapter (expected subandgain or mock)"};if(!p.ok)return await I.prisma.$transaction([I.prisma.transaction.update({where:{reference:g},data:{status:"FAILED",meta:{error:p.message,code:p.code}}}),I.prisma.auditLog.create({data:{actorId:t.user.id,action:"SERVICE_REQUEST_FAILED",resourceType:"Transaction",resourceId:g,diffJson:{amount:u,serviceId:o,action:s,subServiceId:m,reason:p.message,code:p.code,params:l}}})]),S.NextResponse.json({ok:!1,reference:g,error:p.message,message:p.message,code:p.code},{status:400});return await I.prisma.$transaction([I.prisma.transaction.update({where:{reference:g},data:{status:"SUCCESS",meta:{providerRef:p.providerReference,token:p.token}}}),I.prisma.wallet.update({where:{userId:t.user.id},data:{balance:{decrement:u}}}),I.prisma.auditLog.create({data:{actorId:t.user.id,action:"SERVICE_REQUEST_SUCCESS",resourceType:"Transaction",resourceId:g,diffJson:{amount:u,serviceId:o,action:s,subServiceId:m,providerRef:p.providerReference,token:p.token,params:l}}})]),S.NextResponse.json({ok:!0,reference:g,provider:U.provider,providerRef:p.providerReference,token:p.token})}if("verification"===o&&"nin"===s){if(!(String(U.provider.configJson?.adapter||"").toLowerCase().includes("prembly")||U.provider.name.toLowerCase().includes("prembly")))return S.NextResponse.json({error:"Unsupported verification provider. Prembly required."},{status:503});let e=await x({nin:String(l?.nin||""),phone:String(l?.phone||""),firstName:String(l?.firstName||""),lastName:String(l?.lastName||""),dateOfBirth:String(l?.dateOfBirth||""),gender:String(l?.gender||"")},U.provider);if(!e.ok)return await I.prisma.$transaction([I.prisma.transaction.update({where:{reference:g},data:{status:"FAILED",meta:{error:e.message,code:e.code}}}),I.prisma.auditLog.create({data:{actorId:t.user.id,action:"SERVICE_REQUEST_FAILED",resourceType:"Transaction",resourceId:g,diffJson:{amount:u,serviceId:o,action:s,subServiceId:m,reason:e.message,code:e.code,params:l}}})]),S.NextResponse.json({ok:!1,reference:g,error:e.message,code:e.code},{status:400});return await I.prisma.$transaction([I.prisma.transaction.update({where:{reference:g},data:{status:"SUCCESS",meta:{providerRef:e.reference,transactionId:e.transactionId,verificationData:e.data}}}),I.prisma.wallet.update({where:{userId:t.user.id},data:{balance:{decrement:u}}}),I.prisma.auditLog.create({data:{actorId:t.user.id,action:"SERVICE_REQUEST_SUCCESS",resourceType:"Transaction",resourceId:g,diffJson:{amount:u,serviceId:o,action:s,subServiceId:m,providerRef:e.reference,transactionId:e.transactionId,nin:l?.nin,params:l}}})]),S.NextResponse.json({ok:!0,reference:g,provider:U.provider,providerRef:e.reference,transactionId:e.transactionId,data:e.data})}return S.NextResponse.json({ok:!0,reference:g,provider:U.provider,message:"Queued"})}catch(e){return S.NextResponse.json({error:"Service request failed",detail:String(e)},{status:500})}}e.s(["POST",()=>D],953675);var V=e.i(953675);let $=new r.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/service/[category]/[action]/route",pathname:"/api/service/[category]/[action]",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/service/[category]/[action]/route.ts",nextConfigOutput:"",userland:V}),{workAsyncStorage:B,workUnitAsyncStorage:M,serverHooks:j}=$;function J(){return(0,t.patchFetch)({workAsyncStorage:B,workUnitAsyncStorage:M})}async function F(e,r,t){$.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let S="/api/service/[category]/[action]/route";S=S.replace(/\/index$/,"")||"/";let I=await $.prepare(e,r,{srcPage:S,multiZoneDraftMode:!1});if(!I)return r.statusCode=400,r.end("Bad Request"),null==t.waitUntil||t.waitUntil.call(t,Promise.resolve()),null;let{buildId:w,params:h,nextConfig:N,parsedUrl:C,isDraftMode:b,prerenderManifest:k,routerServerContext:T,isOnDemandRevalidate:_,revalidateOnlyGenerated:y,resolvedPathname:A,clientReferenceManifest:U,serverActionsManifest:P}=I,x=(0,d.normalizeAppPath)(S),L=!!(k.dynamicRoutes[x]||k.routes[A]),O=async()=>((null==T?void 0:T.render404)?await T.render404(e,r,C,!1):r.end("This page could not be found"),null);if(L&&!b){let e=!!k.routes[A],r=k.dynamicRoutes[x];if(r&&!1===r.fallback&&!e){if(N.experimental.adapterPath)return await O();throw new R.NoFallbackError}}let D=null;!L||$.isDev||b||(D="/index"===(D=A)?"/":D);let V=!0===$.isDev||!L,B=L&&!V;P&&U&&(0,o.setReferenceManifestsSingleton)({page:S,clientReferenceManifest:U,serverActionsManifest:P,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:P})});let M=e.method||"GET",j=(0,n.getTracer)(),J=j.getActiveScopeSpan(),F={params:h,prerenderManifest:k,renderOpts:{experimental:{authInterrupts:!!N.experimental.authInterrupts},cacheComponents:!!N.cacheComponents,supportsDynamicResponse:V,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:N.cacheLife,waitUntil:t.waitUntil,onClose:e=>{r.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(r,a,t)=>$.onRequestError(e,r,t,T)},sharedContext:{buildId:w}},q=new c.NodeNextRequest(e),H=new c.NodeNextResponse(r),K=u.NextRequestAdapter.fromNodeNextRequest(q,(0,u.signalFromNodeResponse)(r));try{let o=async e=>$.handle(K,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":r.statusCode,"next.rsc":!1});let a=j.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let t=a.get("next.route");if(t){let r=`${M} ${t}`;e.setAttributes({"next.route":t,"http.route":t,"next.span_name":r}),e.updateName(r)}else e.updateName(`${M} ${S}`)}),s=!!(0,i.getRequestMeta)(e,"minimalMode"),d=async i=>{var n,d;let c=async({previousCacheEntry:a})=>{try{if(!s&&_&&y&&!a)return r.statusCode=404,r.setHeader("x-nextjs-cache","REVALIDATED"),r.end("This page could not be found"),null;let n=await o(i);e.fetchMetrics=F.renderOpts.fetchMetrics;let d=F.renderOpts.pendingWaitUntil;d&&t.waitUntil&&(t.waitUntil(d),d=void 0);let c=F.renderOpts.collectedTags;if(!L)return await (0,m.sendResponse)(q,H,n,F.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),r=(0,f.toNodeOutgoingHttpHeaders)(n.headers);c&&(r[v.NEXT_CACHE_TAGS_HEADER]=c),!r["content-type"]&&e.type&&(r["content-type"]=e.type);let a=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=v.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,t=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=v.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:E.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:r},cacheControl:{revalidate:a,expire:t}}}}catch(r){throw(null==a?void 0:a.isStale)&&await $.onRequestError(e,r,{routerKind:"App Router",routePath:S,routeType:"route",revalidateReason:(0,l.getRevalidateReason)({isStaticGeneration:B,isOnDemandRevalidate:_})},T),r}},u=await $.handleResponse({req:e,nextConfig:N,cacheKey:D,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:k,isRoutePPREnabled:!1,isOnDemandRevalidate:_,revalidateOnlyGenerated:y,responseGenerator:c,waitUntil:t.waitUntil,isMinimalMode:s});if(!L)return null;if((null==u||null==(n=u.value)?void 0:n.kind)!==E.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||r.setHeader("x-nextjs-cache",_?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),b&&r.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,f.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&L||p.delete(v.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||r.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,g.getCacheControlHeader)(u.cacheControl)),await (0,m.sendResponse)(q,H,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};J?await d(J):await j.withPropagatedContext(e.headers,()=>j.trace(p.BaseServerSpan.handleRequest,{spanName:`${M} ${S}`,kind:n.SpanKind.SERVER,attributes:{"http.method":M,"http.target":e.url}},d))}catch(r){if(r instanceof R.NoFallbackError||await $.onRequestError(e,r,{routerKind:"App Router",routePath:x,routeType:"route",revalidateReason:(0,l.getRevalidateReason)({isStaticGeneration:B,isOnDemandRevalidate:_})}),L)throw r;return await (0,m.sendResponse)(q,H,new Response(null,{status:500})),null}}e.s(["handler",()=>F,"patchFetch",()=>J,"routeModule",()=>$,"serverHooks",()=>j,"workAsyncStorage",()=>B,"workUnitAsyncStorage",()=>M],413742)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_5216ebb9.js.map