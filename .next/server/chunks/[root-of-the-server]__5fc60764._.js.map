{"version":3,"sources":["turbopack:///[project]/lib/notifications.ts"],"sourcesContent":["import { prisma } from \"@/lib/db\"\r\nimport { sendEmail } from \"@/lib/mailer\"\r\n\r\ninterface NotificationParams {\r\n    userId: string\r\n    type: string\r\n    title: string\r\n    body: string\r\n    email?: {\r\n        subject: string\r\n        html: string\r\n        text?: string\r\n    }\r\n}\r\n\r\nexport async function sendNotification({ userId, type, title, body, email }: NotificationParams) {\r\n    try {\r\n        // 1. Create In-App Notification\r\n        const notification = await prisma.notification.create({\r\n            data: {\r\n                userId,\r\n                type,\r\n                title,\r\n                body,\r\n            },\r\n        })\r\n\r\n        // 2. Send Email Notification if requested\r\n        if (email) {\r\n            const user = await prisma.user.findUnique({\r\n                where: { id: userId },\r\n                select: { email: true },\r\n            })\r\n\r\n            if (user?.email) {\r\n                // We don't await email to prevent blocking the main flow, \r\n                // but it's already handled in sendEmail with catch\r\n                sendEmail({\r\n                    to: user.email,\r\n                    subject: email.subject,\r\n                    html: email.html,\r\n                    text: email.text || body,\r\n                })\r\n            }\r\n        }\r\n\r\n        return notification\r\n    } catch (error) {\r\n        console.error(\"Failed to send notification:\", error)\r\n        return null\r\n    }\r\n}\r\n\r\nexport async function sendAdminNotification({ type, title, body, email }: Omit<NotificationParams, \"userId\">) {\r\n    try {\r\n        // Find all admins\r\n        const admins = await prisma.user.findMany({\r\n            where: { role: \"ADMIN\" },\r\n            select: { id: true, email: true },\r\n        })\r\n\r\n        const results = await Promise.all(\r\n            admins.map(async (admin: { id: string; email: string }) => {\r\n                // Create In-App Notification for each admin\r\n                const notif = await prisma.notification.create({\r\n                    data: {\r\n                        userId: admin.id,\r\n                        type,\r\n                        title,\r\n                        body,\r\n                    },\r\n                })\r\n\r\n                // Send Email to each admin\r\n                if (email) {\r\n                    sendEmail({\r\n                        to: admin.email,\r\n                        subject: email.subject,\r\n                        html: email.html,\r\n                        text: email.text || body,\r\n                    })\r\n                }\r\n\r\n                return notif\r\n            })\r\n        )\r\n\r\n        return results\r\n    } catch (error) {\r\n        console.error(\"Failed to send admin notification:\", error)\r\n        return null\r\n    }\r\n}\r\n"],"names":[],"mappings":"2JAAA,IAAA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QAcO,eAAe,EAAiB,QAAE,CAAM,MAAE,CAAI,OAAE,CAAK,MAAE,CAAI,OAAE,CAAK,CAAsB,EAC3F,GAAI,CAEA,IAAM,EAAe,MAAM,EAAA,MAAM,CAAC,YAAY,CAAC,MAAM,CAAC,CAClD,KAAM,QACF,OACA,QACA,EACA,MACJ,CACJ,GAGA,GAAI,EAAO,CACP,IAAM,EAAO,MAAM,EAAA,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,CACtC,MAAO,CAAE,GAAI,CAAO,EACpB,OAAQ,CAAE,OAAO,CAAK,CAC1B,GAEI,GAAM,OAAO,AAGb,CAAA,EAAA,EAAA,SAAA,AAAS,EAAC,CACN,GAAI,EAAK,KAAK,CACd,QAAS,EAAM,OAAO,CACtB,KAAM,EAAM,IAAI,CAChB,KAAM,EAAM,IAAI,EAAI,CACxB,EAER,CAEA,OAAO,CACX,CAAE,MAAO,EAAO,CAEZ,OADA,QAAQ,KAAK,CAAC,+BAAgC,GACvC,IACX,CACJ,CAEO,eAAe,EAAsB,MAAE,CAAI,OAAE,CAAK,MAAE,CAAI,OAAE,CAAK,CAAsC,EACxG,GAAI,CAEA,IAAM,EAAS,MAAM,EAAA,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,CACtC,MAAO,CAAE,KAAM,OAAQ,EACvB,OAAQ,CAAE,IAAI,EAAM,OAAO,CAAK,CACpC,GA4BA,OA1BgB,AA0BT,MA1Be,QAAQ,GAAG,CAC7B,EAAO,GAAG,CAAC,MAAO,IAEd,IAAM,EAAQ,MAAM,EAAA,MAAM,CAAC,YAAY,CAAC,MAAM,CAAC,CAC3C,KAAM,CACF,OAAQ,EAAM,EAAE,MAChB,QACA,OACA,CACJ,CACJ,GAYA,OATI,GACA,CAAA,EAAA,CADO,CACP,SAAA,AAAS,EAAC,CACN,GAAI,EAAM,KAAK,CACf,QAAS,EAAM,OAAO,CACtB,KAAM,EAAM,IAAI,CAChB,KAAM,EAAM,IAAI,EAAI,CACxB,GAGG,CACX,GAIR,CAAE,MAAO,EAAO,CAEZ,OADA,QAAQ,KAAK,CAAC,qCAAsC,GAC7C,IACX,CACJ"}