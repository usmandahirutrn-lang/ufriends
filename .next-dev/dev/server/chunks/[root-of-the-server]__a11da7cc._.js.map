{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Downloads/ufriends%20version%201/lib/db.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\"\n\nconst globalForPrisma = global as unknown as { prisma: PrismaClient | undefined }\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: [\"error\", \"warn\"],\n  })\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM;AAEC,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK;QAAC;QAAS;KAAO;AACxB;AAEF,wCAA2C,gBAAgB,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Downloads/ufriends%20version%201/lib/jwt.ts"],"sourcesContent":["import { SignJWT, jwtVerify, JWTPayload } from \"jose\";\n\nconst encoder = new TextEncoder();\n\nfunction getAccessSecret() {\n  const secret = process.env.JWT_SECRET || \"dev_access_secret\";\n  return encoder.encode(secret);\n}\n\nfunction getRefreshSecret() {\n  const secret = process.env.JWT_REFRESH_SECRET || \"dev_refresh_secret\";\n  return encoder.encode(secret);\n}\n\nfunction nowSeconds() {\n  return Math.floor(Date.now() / 1000);\n}\n\nexport type TokenPayload = {\n  sub: string; // user id\n  email: string;\n  role: string;\n  jti?: string; // token id for refresh\n};\n\nexport async function signAccessToken(payload: TokenPayload, expiresInSeconds = 15 * 60) {\n  return new SignJWT(payload as JWTPayload)\n    .setProtectedHeader({ alg: \"HS256\" })\n    .setIssuedAt()\n    .setExpirationTime(nowSeconds() + expiresInSeconds)\n    .sign(getAccessSecret());\n}\n\nexport async function signRefreshToken(payload: TokenPayload, expiresInSeconds = 7 * 24 * 60 * 60) {\n  return new SignJWT(payload as JWTPayload)\n    .setProtectedHeader({ alg: \"HS256\" })\n    .setIssuedAt()\n    .setExpirationTime(nowSeconds() + expiresInSeconds)\n    .sign(getRefreshSecret());\n}\n\nexport async function verifyAccessToken<T = TokenPayload>(token: string) {\n  const { payload } = await jwtVerify(token, getAccessSecret());\n  return payload as T;\n}\n\nexport async function verifyRefreshToken<T = TokenPayload>(token: string) {\n  const { payload } = await jwtVerify(token, getRefreshSecret());\n  return payload as T;\n}"],"names":[],"mappings":";;;;;;;;;;AAAA;AAAA;;AAEA,MAAM,UAAU,IAAI;AAEpB,SAAS;IACP,MAAM,SAAS,QAAQ,GAAG,CAAC,UAAU,IAAI;IACzC,OAAO,QAAQ,MAAM,CAAC;AACxB;AAEA,SAAS;IACP,MAAM,SAAS,QAAQ,GAAG,CAAC,kBAAkB,IAAI;IACjD,OAAO,QAAQ,MAAM,CAAC;AACxB;AAEA,SAAS;IACP,OAAO,KAAK,KAAK,CAAC,KAAK,GAAG,KAAK;AACjC;AASO,eAAe,gBAAgB,OAAqB,EAAE,mBAAmB,KAAK,EAAE;IACrF,OAAO,IAAI,kKAAO,CAAC,SAChB,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,WAAW,GACX,iBAAiB,CAAC,eAAe,kBACjC,IAAI,CAAC;AACV;AAEO,eAAe,iBAAiB,OAAqB,EAAE,mBAAmB,IAAI,KAAK,KAAK,EAAE;IAC/F,OAAO,IAAI,kKAAO,CAAC,SAChB,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,WAAW,GACX,iBAAiB,CAAC,eAAe,kBACjC,IAAI,CAAC;AACV;AAEO,eAAe,kBAAoC,KAAa;IACrE,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,sKAAS,EAAC,OAAO;IAC3C,OAAO;AACT;AAEO,eAAe,mBAAqC,KAAa;IACtE,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,sKAAS,EAAC,OAAO;IAC3C,OAAO;AACT","debugId":null}},
    {"offset": {"line": 273, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Downloads/ufriends%20version%201/lib/security.ts"],"sourcesContent":["import arcjet, { shield, validateEmail } from \"@arcjet/next\"\n\ntype AJInstance = ReturnType<typeof arcjet> | null\n\n// Create a shared Arcjet instance with common rules.\n// In development, ARCJET_KEY may be missing, so we fail open.\nexport const aj: AJInstance = process.env.ARCJET_KEY\n  ? arcjet({\n      key: process.env.ARCJET_KEY!,\n      rules: [\n        shield({ mode: \"LIVE\" }),\n      ],\n    })\n  : null\n\n// Email-validation instance for routes that need email context\nexport const ajWithEmail: AJInstance = process.env.ARCJET_KEY\n  ? arcjet({\n      key: process.env.ARCJET_KEY!,\n      rules: [\n        shield({ mode: \"LIVE\" }),\n        validateEmail({ mode: \"LIVE\", deny: [\"DISPOSABLE\", \"INVALID\", \"NO_MX_RECORDS\"] }),\n      ],\n    })\n  : null\n\nexport async function protect(req: Request, opts?: { email?: string }) {\n  if (!aj) return { allowed: true }\n  try {\n    const decision = await (opts?.email && ajWithEmail\n      ? (ajWithEmail as any).protect(req as any, { email: opts.email })\n      : (aj as any).protect(req as any))\n    if (decision?.isDenied?.()) return { allowed: false }\n    return { allowed: true }\n  } catch {\n    // Fail open in dev\n    return { allowed: true }\n  }\n}"],"names":[],"mappings":";;;;;;;;AAAA;AAAA;;AAMO,MAAM,KAAiB,QAAQ,GAAG,CAAC,UAAU,GAChD,IAAA,sKAAM,EAAC;IACL,KAAK,QAAQ,GAAG,CAAC,UAAU;IAC3B,OAAO;QACL,IAAA,2IAAM,EAAC;YAAE,MAAM;QAAO;KACvB;AACH,KACA;AAGG,MAAM,cAA0B,QAAQ,GAAG,CAAC,UAAU,GACzD,IAAA,sKAAM,EAAC;IACL,KAAK,QAAQ,GAAG,CAAC,UAAU;IAC3B,OAAO;QACL,IAAA,2IAAM,EAAC;YAAE,MAAM;QAAO;QACtB,IAAA,kJAAa,EAAC;YAAE,MAAM;YAAQ,MAAM;gBAAC;gBAAc;gBAAW;aAAgB;QAAC;KAChF;AACH,KACA;AAEG,eAAe,QAAQ,GAAY,EAAE,IAAyB;IACnE,IAAI,CAAC,IAAI,OAAO;QAAE,SAAS;IAAK;IAChC,IAAI;QACF,MAAM,WAAW,MAAM,CAAC,MAAM,SAAS,cACnC,AAAC,YAAoB,OAAO,CAAC,KAAY;YAAE,OAAO,KAAK,KAAK;QAAC,KAC7D,AAAC,GAAW,OAAO,CAAC,IAAW;QACnC,IAAI,UAAU,cAAc,OAAO;YAAE,SAAS;QAAM;QACpD,OAAO;YAAE,SAAS;QAAK;IACzB,EAAE,OAAM;QACN,mBAAmB;QACnB,OAAO;YAAE,SAAS;QAAK;IACzB;AACF","debugId":null}},
    {"offset": {"line": 339, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Downloads/ufriends%20version%201/lib/validation.ts"],"sourcesContent":["import { z } from \"zod\"\nimport { ZodXssSanitizer, ACTION_LEVELS } from \"zod-xss-sanitizer\"\n\n// Shared XSS sanitizer instance\nexport const sanitizer = ZodXssSanitizer.sanitizer({ actionLevel: ACTION_LEVELS.SANITIZE })\n\nexport function sanitizeEmail(input: string) {\n  return sanitizer.parse(z.string().trim().toLowerCase().email().parse(input))\n}\n\nexport function sanitizeString(input: string) {\n  return sanitizer.parse(z.string().trim().min(1).parse(input))\n}\n\nexport function sanitizePhone(input: string) {\n  const schema = z.string().trim().regex(/^\\+?[0-9]{10,15}$/i, { message: \"Invalid phone\" })\n  return sanitizer.parse(schema.parse(input))\n}\n\nexport function isValidUrl(input: string) {\n  const res = z.string().url().safeParse(input)\n  return res.success\n}"],"names":[],"mappings":";;;;;;;;;;;;AAAA;AACA;;;AAGO,MAAM,YAAY,8KAAe,CAAC,SAAS,CAAC;IAAE,aAAa,4KAAa,CAAC,QAAQ;AAAC;AAElF,SAAS,cAAc,KAAa;IACzC,OAAO,UAAU,KAAK,CAAC,yKAAC,CAAC,MAAM,GAAG,IAAI,GAAG,WAAW,GAAG,KAAK,GAAG,KAAK,CAAC;AACvE;AAEO,SAAS,eAAe,KAAa;IAC1C,OAAO,UAAU,KAAK,CAAC,yKAAC,CAAC,MAAM,GAAG,IAAI,GAAG,GAAG,CAAC,GAAG,KAAK,CAAC;AACxD;AAEO,SAAS,cAAc,KAAa;IACzC,MAAM,SAAS,yKAAC,CAAC,MAAM,GAAG,IAAI,GAAG,KAAK,CAAC,sBAAsB;QAAE,SAAS;IAAgB;IACxF,OAAO,UAAU,KAAK,CAAC,OAAO,KAAK,CAAC;AACtC;AAEO,SAAS,WAAW,KAAa;IACtC,MAAM,MAAM,yKAAC,CAAC,MAAM,GAAG,GAAG,GAAG,SAAS,CAAC;IACvC,OAAO,IAAI,OAAO;AACpB","debugId":null}},
    {"offset": {"line": 378, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Downloads/ufriends%20version%201/lib/auth.ts"],"sourcesContent":["import NextAuth from \"next-auth\"\nimport type { NextAuthOptions } from \"next-auth\"\nimport Credentials from \"next-auth/providers/credentials\"\nimport { prisma } from \"@/lib/db\"\nimport bcrypt from \"bcryptjs\"\nimport { protect } from \"@/lib/security\"\nimport Joi from \"joi\"\nimport { sanitizer } from \"@/lib/validation\"\n\nconst isProd = process.env.NODE_ENV === \"production\"\n\nexport const authOptions: NextAuthOptions = {\n  session: { strategy: \"jwt\" },\n  providers: [\n    Credentials({\n      name: \"Credentials\",\n      credentials: {\n        email: { label: \"Email\", type: \"email\" },\n        password: { label: \"Password\", type: \"password\" },\n      },\n      async authorize(credentials, req) {\n        // Basic input validation with Joi\n        const schema = Joi.object({\n          // Allow non-public TLDs (e.g., .local) in development; enforce strict in production\n          email: isProd\n            ? Joi.string().email().required()\n            : Joi.string().email({ tlds: { allow: false } }).required(),\n          password: Joi.string().min(6).required(),\n        })\n        const { error, value } = schema.validate({\n          email: credentials?.email,\n          password: credentials?.password,\n        })\n        if (error) return null\n\n        // Sanitize email using shared sanitizer\n        const safeEmail = sanitizer.parse(value.email.trim().toLowerCase())\n\n        // Centralized protection: Shield/email validation handled by shared helper\n        try {\n          const sec = await protect(req as any, { email: safeEmail })\n          if (!sec.allowed) return null\n        } catch {\n          // Fail open to avoid login lockouts if Arcjet fails\n        }\n\n        // Credentials auth\n        const user = await prisma.user.findUnique({ where: { email: safeEmail } })\n        if (!user) return null\n        const ok = await bcrypt.compare(value.password, user.passwordHash)\n        if (!ok) return null\n        return { id: user.id, email: user.email, role: user.role }\n      },\n    }),\n  ],\n  callbacks: {\n    async jwt({ token, user }) {\n      if (user) {\n        ;(token as any).id = (user as any).id\n        ;(token as any).role = (user as any).role\n      }\n      return token\n    },\n    async session({ session, token }) {\n      if (session.user) {\n        ;(session.user as any).id = (token as any).id\n        ;(session.user as any).role = (token as any).role\n      }\n      return session\n    },\n  },\n}"],"names":[],"mappings":";;;;AAEA;AACA;AACA;AACA;AACA;AACA;;;;;;;AAEA,MAAM,SAAS,oDAAyB;AAEjC,MAAM,cAA+B;IAC1C,SAAS;QAAE,UAAU;IAAM;IAC3B,WAAW;QACT,IAAA,qKAAW,EAAC;YACV,MAAM;YACN,aAAa;gBACX,OAAO;oBAAE,OAAO;oBAAS,MAAM;gBAAQ;gBACvC,UAAU;oBAAE,OAAO;oBAAY,MAAM;gBAAW;YAClD;YACA,MAAM,WAAU,WAAW,EAAE,GAAG;gBAC9B,kCAAkC;gBAClC,MAAM,SAAS,gJAAG,CAAC,MAAM,CAAC;oBACxB,oFAAoF;oBACpF,OAAO,sCACH,0BACA,gJAAG,CAAC,MAAM,GAAG,KAAK,CAAC;wBAAE,MAAM;4BAAE,OAAO;wBAAM;oBAAE,GAAG,QAAQ;oBAC3D,UAAU,gJAAG,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG,QAAQ;gBACxC;gBACA,MAAM,EAAE,KAAK,EAAE,KAAK,EAAE,GAAG,OAAO,QAAQ,CAAC;oBACvC,OAAO,aAAa;oBACpB,UAAU,aAAa;gBACzB;gBACA,IAAI,OAAO,OAAO;gBAElB,wCAAwC;gBACxC,MAAM,YAAY,gIAAS,CAAC,KAAK,CAAC,MAAM,KAAK,CAAC,IAAI,GAAG,WAAW;gBAEhE,2EAA2E;gBAC3E,IAAI;oBACF,MAAM,MAAM,MAAM,IAAA,4HAAO,EAAC,KAAY;wBAAE,OAAO;oBAAU;oBACzD,IAAI,CAAC,IAAI,OAAO,EAAE,OAAO;gBAC3B,EAAE,OAAM;gBACN,oDAAoD;gBACtD;gBAEA,mBAAmB;gBACnB,MAAM,OAAO,MAAM,qHAAM,CAAC,IAAI,CAAC,UAAU,CAAC;oBAAE,OAAO;wBAAE,OAAO;oBAAU;gBAAE;gBACxE,IAAI,CAAC,MAAM,OAAO;gBAClB,MAAM,KAAK,MAAM,8IAAM,CAAC,OAAO,CAAC,MAAM,QAAQ,EAAE,KAAK,YAAY;gBACjE,IAAI,CAAC,IAAI,OAAO;gBAChB,OAAO;oBAAE,IAAI,KAAK,EAAE;oBAAE,OAAO,KAAK,KAAK;oBAAE,MAAM,KAAK,IAAI;gBAAC;YAC3D;QACF;KACD;IACD,WAAW;QACT,MAAM,KAAI,EAAE,KAAK,EAAE,IAAI,EAAE;YACvB,IAAI,MAAM;;gBACN,MAAc,EAAE,GAAG,AAAC,KAAa,EAAE;gBACnC,MAAc,IAAI,GAAG,AAAC,KAAa,IAAI;YAC3C;YACA,OAAO;QACT;QACA,MAAM,SAAQ,EAAE,OAAO,EAAE,KAAK,EAAE;YAC9B,IAAI,QAAQ,IAAI,EAAE;;gBACd,QAAQ,IAAI,CAAS,EAAE,GAAG,AAAC,MAAc,EAAE;gBAC3C,QAAQ,IAAI,CAAS,IAAI,GAAG,AAAC,MAAc,IAAI;YACnD;YACA,OAAO;QACT;IACF;AACF","debugId":null}},
    {"offset": {"line": 479, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Downloads/ufriends%20version%201/lib/jwt-auth.ts"],"sourcesContent":["import { verifyAccessToken } from \"./jwt\"\nimport { getServerSession } from \"next-auth\"\nimport { authOptions } from \"@/lib/auth\"\n\nexport type AuthUser = { id: string; email?: string | null; role?: string | null }\n\nexport async function getAuthUser(req: Request): Promise<AuthUser | null> {\n  // Prefer Authorization: Bearer access token\n  const authHeader = (req as any).headers?.get?.(\"authorization\") || \"\"\n  const [, token] = authHeader.split(\" \")\n  if (authHeader.toLowerCase().startsWith(\"bearer \") && token) {\n    try {\n      const payload: any = await verifyAccessToken(token)\n      return { id: payload.sub, email: payload.email, role: payload.role }\n    } catch {}\n  }\n\n  // Fallback to NextAuth session\n  try {\n    const session = await getServerSession(authOptions)\n    if (session?.user?.id) {\n      return { id: (session.user as any).id, email: session.user.email, role: (session.user as any).role }\n    }\n  } catch {}\n\n  return null\n}"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAIO,eAAe,YAAY,GAAY;IAC5C,4CAA4C;IAC5C,MAAM,aAAa,AAAC,IAAY,OAAO,EAAE,MAAM,oBAAoB;IACnE,MAAM,GAAG,MAAM,GAAG,WAAW,KAAK,CAAC;IACnC,IAAI,WAAW,WAAW,GAAG,UAAU,CAAC,cAAc,OAAO;QAC3D,IAAI;YACF,MAAM,UAAe,MAAM,IAAA,iIAAiB,EAAC;YAC7C,OAAO;gBAAE,IAAI,QAAQ,GAAG;gBAAE,OAAO,QAAQ,KAAK;gBAAE,MAAM,QAAQ,IAAI;YAAC;QACrE,EAAE,OAAM,CAAC;IACX;IAEA,+BAA+B;IAC/B,IAAI;QACF,MAAM,UAAU,MAAM,IAAA,2JAAgB,EAAC,4HAAW;QAClD,IAAI,SAAS,MAAM,IAAI;YACrB,OAAO;gBAAE,IAAI,AAAC,QAAQ,IAAI,CAAS,EAAE;gBAAE,OAAO,QAAQ,IAAI,CAAC,KAAK;gBAAE,MAAM,AAAC,QAAQ,IAAI,CAAS,IAAI;YAAC;QACrG;IACF,EAAE,OAAM,CAAC;IAET,OAAO;AACT","debugId":null}},
    {"offset": {"line": 520, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Downloads/ufriends%20version%201/lib/require-auth.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { getAuthUser, AuthUser } from \"@/lib/jwt-auth\"\n\nexport type RequireAuthOptions = {\n  roles?: Array<string>\n}\n\nexport type RequireAuthResult = {\n  ok: true\n  user: AuthUser\n} | {\n  ok: false\n  response: NextResponse\n}\n\nexport async function requireAuth(req: Request, options: RequireAuthOptions = {}): Promise<RequireAuthResult> {\n  const user = await getAuthUser(req)\n  if (!user?.id) {\n    return { ok: false, response: NextResponse.json({ error: \"Unauthorized\" }, { status: 401 }) }\n  }\n  if (options.roles && user.role && !options.roles.includes(user.role)) {\n    return { ok: false, response: NextResponse.json({ error: \"Forbidden\" }, { status: 403 }) }\n  }\n  return { ok: true, user }\n}"],"names":[],"mappings":";;;;AAAA;AACA;;;AAcO,eAAe,YAAY,GAAY,EAAE,UAA8B,CAAC,CAAC;IAC9E,MAAM,OAAO,MAAM,IAAA,mIAAW,EAAC;IAC/B,IAAI,CAAC,MAAM,IAAI;QACb,OAAO;YAAE,IAAI;YAAO,UAAU,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QAAG;IAC9F;IACA,IAAI,QAAQ,KAAK,IAAI,KAAK,IAAI,IAAI,CAAC,QAAQ,KAAK,CAAC,QAAQ,CAAC,KAAK,IAAI,GAAG;QACpE,OAAO;YAAE,IAAI;YAAO,UAAU,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAY,GAAG;gBAAE,QAAQ;YAAI;QAAG;IAC3F;IACA,OAAO;QAAE,IAAI;QAAM;IAAK;AAC1B","debugId":null}},
    {"offset": {"line": 559, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Downloads/ufriends%20version%201/lib/monnify.ts"],"sourcesContent":["import crypto from \"crypto\"\r\n\r\nexport function verifyMonnifySignature(rawBody: string, signatureHeader: string | null | undefined, secret: string): boolean {\r\n  if (!secret) return false\r\n  if (!rawBody) return false\r\n  if (!signatureHeader) return false\r\n\r\n  // Monnify signatures are typically HMAC-SHA256 over raw body with your secret\r\n  const hmac = crypto.createHmac(\"sha256\", secret).update(rawBody).digest(\"hex\")\r\n  const base64 = crypto.createHmac(\"sha256\", secret).update(rawBody).digest(\"base64\")\r\n\r\n  // Accept either hex or base64 depending on provider config\r\n  return signatureHeader === hmac || signatureHeader === base64\r\n}\r\n\r\nexport type MonnifyWebhookPayload = {\r\n  transactionReference?: string\r\n  paymentReference?: string\r\n  reference?: string\r\n  status?: string\r\n  paymentStatus?: string\r\n  amount?: number | string\r\n  paidAmount?: number | string\r\n  customer?: { email?: string; name?: string; userId?: string }\r\n  meta?: Record<string, unknown>\r\n  [k: string]: unknown\r\n}\r\n\r\nexport function getWebhookReference(body: MonnifyWebhookPayload): string | undefined {\r\n  return body?.transactionReference || body?.paymentReference || body?.reference\r\n}\r\n\r\nexport function getWebhookStatus(body: MonnifyWebhookPayload): string | undefined {\r\n  return body?.status || body?.paymentStatus\r\n}\r\n\r\nexport function getWebhookAmount(body: MonnifyWebhookPayload): number {\r\n  const val = body?.amount ?? body?.paidAmount ?? 0\r\n  const n = typeof val === \"string\" ? Number(val) : (val as number)\r\n  return Number.isFinite(n) ? n : 0\r\n}\r\n\r\nexport async function monnifyLogin(): Promise<string> {\r\n  const base = process.env.MONNIFY_BASE_URL || \"https://sandbox.monnify.com/api/v1\"\r\n  const apiKey = process.env.MONNIFY_API_KEY || \"\"\r\n  const secretKey = process.env.MONNIFY_SECRET_KEY || \"\"\r\n  if (!apiKey || !secretKey) {\r\n    throw new Error(\"Missing MONNIFY_API_KEY or MONNIFY_SECRET_KEY\")\r\n  }\r\n  const auth = Buffer.from(`${apiKey}:${secretKey}`).toString(\"base64\")\r\n  const res = await fetch(`${base}/auth/login`, {\r\n    method: \"POST\",\r\n    headers: { Authorization: `Basic ${auth}`, \"Content-Type\": \"application/json\" },\r\n  })\r\n  const json: any = await res.json().catch(() => ({}))\r\n  const token = json?.accessToken || json?.responseBody?.accessToken\r\n  if (!res.ok || !token) {\r\n    throw new Error(`Monnify login failed: ${res.status} ${JSON.stringify(json)}`)\r\n  }\r\n  return token\r\n}\r\n\r\n// Create or fetch a reserved account for a user\r\nexport async function monnifyCreateReservedAccount(input: {\r\n  accountReference: string\r\n  accountName: string\r\n  customerName: string\r\n  customerEmail: string\r\n  bvn?: string\r\n  currencyCode?: string\r\n}): Promise<{ accountNumber: string; bankName: string }> {\r\n  const base = process.env.MONNIFY_BASE_URL || \"https://sandbox.monnify.com/api/v1\"\r\n  const contractCode = process.env.MONNIFY_CONTRACT_CODE || \"\"\r\n  if (!contractCode) {\r\n    throw new Error(\"Missing MONNIFY_CONTRACT_CODE\")\r\n  }\r\n  const token = await monnifyLogin()\r\n  const body = {\r\n    accountReference: input.accountReference,\r\n    accountName: input.accountName,\r\n    customerName: input.customerName,\r\n    customerEmail: input.customerEmail,\r\n    bvn: input.bvn,\r\n    currencyCode: input.currencyCode || \"NGN\",\r\n    contractCode,\r\n  }\r\n  const res = await fetch(`${base}/reserved-accounts`, {\r\n    method: \"POST\",\r\n    headers: { Authorization: `Bearer ${token}`, \"Content-Type\": \"application/json\" },\r\n    body: JSON.stringify(body),\r\n  })\r\n  const json: any = await res.json().catch(() => ({}))\r\n  const payload = json?.responseBody || json\r\n  const accountNumber = String(payload?.accountNumber || payload?.account?.number || \"\")\r\n  const bankName = String(payload?.bankName || payload?.bank?.name || \"Monnify Partner Bank\")\r\n  if (!res.ok || !accountNumber) {\r\n    throw new Error(`Monnify reserved account failed: ${res.status} ${JSON.stringify(json)}`)\r\n  }\r\n  return { accountNumber, bankName }\r\n}\r\n\r\nexport async function monnifyInitTransaction(input: {\r\n  amount: number\r\n  customerName: string\r\n  customerEmail: string\r\n  paymentDescription?: string\r\n  currencyCode?: string\r\n  contractCode?: string\r\n  redirectUrl: string\r\n  paymentReference: string\r\n}): Promise<{ paymentUrl: string; checkoutUrl?: string }> {\r\n  const base = process.env.MONNIFY_BASE_URL || \"https://sandbox.monnify.com/api/v1\"\r\n  const contractCode = input.contractCode || process.env.MONNIFY_CONTRACT_CODE || \"\"\r\n  if (!contractCode) {\r\n    throw new Error(\"Missing MONNIFY_CONTRACT_CODE\")\r\n  }\r\n  const token = await monnifyLogin()\r\n  const body = {\r\n    amount: input.amount,\r\n    customerName: input.customerName,\r\n    customerEmail: input.customerEmail,\r\n    paymentDescription: input.paymentDescription || `Wallet funding - ${input.paymentReference}`,\r\n    currencyCode: input.currencyCode || \"NGN\",\r\n    contractCode,\r\n    redirectUrl: input.redirectUrl,\r\n    paymentReference: input.paymentReference,\r\n  }\r\n  const res = await fetch(`${base}/merchant/transactions/init-transaction`, {\r\n    method: \"POST\",\r\n    headers: { Authorization: `Bearer ${token}`, \"Content-Type\": \"application/json\" },\r\n    body: JSON.stringify(body),\r\n  })\r\n  const json: any = await res.json().catch(() => ({}))\r\n  const payload = json?.responseBody || json\r\n  const paymentUrl = String(payload?.paymentUrl || payload?.checkoutUrl || \"\")\r\n  const checkoutUrl = String(payload?.checkoutUrl || \"\")\r\n  if (!res.ok || !paymentUrl) {\r\n    throw new Error(`Monnify init transaction failed: ${res.status} ${JSON.stringify(json)}`)\r\n  }\r\n  return { paymentUrl, checkoutUrl: checkoutUrl || undefined }\r\n}"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 697, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Downloads/ufriends%20version%201/lib/paymentpoint.ts"],"sourcesContent":["import crypto from \"crypto\"\n\nexport function verifyPaymentPointSignature(rawBody: string, signatureHeader: string | null | undefined, secret: string): boolean {\n  if (!secret) return false\n  if (!rawBody) return false\n  if (!signatureHeader) return false\n\n  // Assume HMAC-SHA256 over raw body using PAYMENTPOINT secret\n  const hmac = crypto.createHmac(\"sha256\", secret).update(rawBody).digest(\"hex\")\n  const base64 = crypto.createHmac(\"sha256\", secret).update(rawBody).digest(\"base64\")\n  return signatureHeader === hmac || signatureHeader === base64\n}\n\nexport type PaymentPointWebhookPayload = {\n  reference?: string\n  status?: string\n  amount?: number | string\n  customer?: { email?: string; name?: string; userId?: string }\n  meta?: Record<string, unknown>\n  [k: string]: unknown\n}\n\nexport function getPPReference(body: PaymentPointWebhookPayload): string | undefined {\n  return body?.reference\n}\n\nexport function getPPStatus(body: PaymentPointWebhookPayload): string | undefined {\n  return body?.status\n}\n\nexport function getPPAmount(body: PaymentPointWebhookPayload): number {\n  const val = body?.amount ?? 0\n  const n = typeof val === \"string\" ? Number(val) : (val as number)\n  return Number.isFinite(n) ? n : 0\n}\n\nexport async function paymentPointCreateVirtualAccount(input: {\n  email: string\n  name: string\n  phoneNumber?: string\n  bankCode?: string\n  businessId?: string\n}): Promise<{ accountNumber: string; bankName: string; accountName: string; accountReference?: string }> {\n  const base = process.env.PAYMENTPOINT_BASE_URL || \"https://api.paymentpoint.co/api/v1\"\n  const apiKey = process.env.PAYMENTPOINT_API_KEY || process.env.PAYMENTPOINT_PUBLIC_KEY || \"\"\n  const apiSecret = process.env.PAYMENTPOINT_API_SECRET || \"\"\n  if (!apiKey || !apiSecret) {\n    throw new Error(\"Missing PAYMENTPOINT_API_KEY or PAYMENTPOINT_API_SECRET\")\n  }\n  const headers = {\n    Authorization: `Bearer ${apiSecret}`,\n    \"api-key\": apiKey,\n    \"Content-Type\": \"application/json\",\n  }\n  const body = {\n    email: input.email,\n    name: input.name,\n    phoneNumber: input.phoneNumber,\n    bankCode: input.bankCode || \"29046\",\n    businessId: input.businessId,\n  }\n  const res = await fetch(`${base}/createVirtualAccount`, {\n    method: \"POST\",\n    headers,\n    body: JSON.stringify(body),\n  })\n  const json: any = await res.json().catch(() => ({}))\n  const payload = json?.data || json?.responseBody || json\n  const accountNumber = String(\n    payload?.accountNumber || payload?.account?.number || payload?.virtualAccountNumber || \"\",\n  )\n  const bankName = String(payload?.bankName || payload?.bank?.name || \"PaymentPoint Partner Bank\")\n  const accountName = String(payload?.accountName || input.name)\n  const accountReference = payload?.accountReference || payload?.reference\n  if (!res.ok || !accountNumber) {\n    throw new Error(`PaymentPoint create virtual account failed: ${res.status} ${JSON.stringify(json)}`)\n  }\n  return { accountNumber, bankName, accountName, accountReference }\n}"],"names":[],"mappings":";;;;;;;;;;;;AAAA;;AAEO,SAAS,4BAA4B,OAAe,EAAE,eAA0C,EAAE,MAAc;IACrH,IAAI,CAAC,QAAQ,OAAO;IACpB,IAAI,CAAC,SAAS,OAAO;IACrB,IAAI,CAAC,iBAAiB,OAAO;IAE7B,6DAA6D;IAC7D,MAAM,OAAO,gHAAM,CAAC,UAAU,CAAC,UAAU,QAAQ,MAAM,CAAC,SAAS,MAAM,CAAC;IACxE,MAAM,SAAS,gHAAM,CAAC,UAAU,CAAC,UAAU,QAAQ,MAAM,CAAC,SAAS,MAAM,CAAC;IAC1E,OAAO,oBAAoB,QAAQ,oBAAoB;AACzD;AAWO,SAAS,eAAe,IAAgC;IAC7D,OAAO,MAAM;AACf;AAEO,SAAS,YAAY,IAAgC;IAC1D,OAAO,MAAM;AACf;AAEO,SAAS,YAAY,IAAgC;IAC1D,MAAM,MAAM,MAAM,UAAU;IAC5B,MAAM,IAAI,OAAO,QAAQ,WAAW,OAAO,OAAQ;IACnD,OAAO,OAAO,QAAQ,CAAC,KAAK,IAAI;AAClC;AAEO,eAAe,iCAAiC,KAMtD;IACC,MAAM,OAAO,QAAQ,GAAG,CAAC,qBAAqB,IAAI;IAClD,MAAM,SAAS,QAAQ,GAAG,CAAC,oBAAoB,IAAI,QAAQ,GAAG,CAAC,uBAAuB,IAAI;IAC1F,MAAM,YAAY,QAAQ,GAAG,CAAC,uBAAuB,IAAI;IACzD,IAAI,CAAC,UAAU,CAAC,WAAW;QACzB,MAAM,IAAI,MAAM;IAClB;IACA,MAAM,UAAU;QACd,eAAe,CAAC,OAAO,EAAE,WAAW;QACpC,WAAW;QACX,gBAAgB;IAClB;IACA,MAAM,OAAO;QACX,OAAO,MAAM,KAAK;QAClB,MAAM,MAAM,IAAI;QAChB,aAAa,MAAM,WAAW;QAC9B,UAAU,MAAM,QAAQ,IAAI;QAC5B,YAAY,MAAM,UAAU;IAC9B;IACA,MAAM,MAAM,MAAM,MAAM,GAAG,KAAK,qBAAqB,CAAC,EAAE;QACtD,QAAQ;QACR;QACA,MAAM,KAAK,SAAS,CAAC;IACvB;IACA,MAAM,OAAY,MAAM,IAAI,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;IAClD,MAAM,UAAU,MAAM,QAAQ,MAAM,gBAAgB;IACpD,MAAM,gBAAgB,OACpB,SAAS,iBAAiB,SAAS,SAAS,UAAU,SAAS,wBAAwB;IAEzF,MAAM,WAAW,OAAO,SAAS,YAAY,SAAS,MAAM,QAAQ;IACpE,MAAM,cAAc,OAAO,SAAS,eAAe,MAAM,IAAI;IAC7D,MAAM,mBAAmB,SAAS,oBAAoB,SAAS;IAC/D,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,eAAe;QAC7B,MAAM,IAAI,MAAM,CAAC,4CAA4C,EAAE,IAAI,MAAM,CAAC,CAAC,EAAE,KAAK,SAAS,CAAC,OAAO;IACrG;IACA,OAAO;QAAE;QAAe;QAAU;QAAa;IAAiB;AAClE","debugId":null}},
    {"offset": {"line": 775, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Downloads/ufriends%20version%201/app/api/wallet/fund/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\r\nimport { prisma } from \"@/lib/db\"\r\nimport { requireAuth } from \"@/lib/require-auth\"\r\nimport { protect } from \"@/lib/security\"\r\nimport crypto from \"crypto\"\r\nimport { monnifyCreateReservedAccount, monnifyInitTransaction } from \"@/lib/monnify\"\r\nimport { paymentPointCreateVirtualAccount } from \"@/lib/paymentpoint\"\r\nimport { z } from \"zod\"\r\n\r\n// Arcjet protection via shared helper\r\n\r\nfunction deriveVirtualAccountNumber(userId: string) {\r\n  const bytes = crypto.createHash(\"sha256\").update(userId).digest()\r\n  let digits = \"\"\r\n  for (let i = 0; i < bytes.length && digits.length < 10; i++) {\r\n    digits += (bytes[i] % 10).toString()\r\n  }\r\n  return `9${digits}`\r\n}\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const auth = await requireAuth(req)\r\n    if (!auth.ok) return auth.response\r\n\r\n    const sec = await protect(req as any)\r\n    if (!sec.allowed) {\r\n      return NextResponse.json({ error: \"Forbidden\" }, { status: 403 })\r\n    }\r\n\r\n    const body = await req.json()\r\n    const FundSchema = z.object({\r\n      provider: z.enum([\"paymentpoint\", \"bank-transfer\"]),\r\n      amount: z.number().positive(),\r\n    })\r\n    const parsed = FundSchema.safeParse({\r\n      provider: String(body?.provider || \"\").toLowerCase(),\r\n      amount: Number(body?.amount ?? 0),\r\n    })\r\n    if (!parsed.success) {\r\n      return NextResponse.json({ error: \"Invalid request\", detail: parsed.error.flatten() }, { status: 400 })\r\n    }\r\n    const { provider, amount } = parsed.data\r\n\r\n    const reference = `FUND-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`\r\n\r\n    const gateway = provider === \"bank-transfer\" ? \"Monnify\" : \"PaymentPoint\"\r\n\r\n    await prisma.$transaction([\r\n      prisma.transaction.create({\r\n        data: {\r\n          userId: auth.user.id,\r\n          type: \"WALLET_CREDIT\",\r\n          amount,\r\n          status: \"PENDING\",\r\n          reference,\r\n          meta: { provider },\r\n        },\r\n      }),\r\n      prisma.payment.create({\r\n        data: {\r\n          userId: auth.user.id,\r\n          gateway,\r\n          amount,\r\n          status: \"INIT\",\r\n          reference,\r\n        },\r\n      }),\r\n      prisma.auditLog.create({\r\n        data: {\r\n          actorId: auth.user.id,\r\n          action: \"WALLET_FUND_INIT\",\r\n          resourceType: \"Payment\",\r\n          resourceId: reference,\r\n          diffJson: { amount, provider },\r\n        },\r\n      }),\r\n    ])\r\n\r\n    if (provider === \"paymentpoint\") {\r\n      let accountNumber: string | undefined\r\n      let bankName = \"PaymentPoint Partner Bank\"\r\n      let wasCreated = false\r\n      try {\r\n        const va = await prisma.virtualAccount.findUnique({ where: { userId: auth.user.id } })\r\n        accountNumber = va?.accountNumber\r\n        bankName = va?.bankName || bankName\r\n        if (!accountNumber) {\r\n          const userInfo = await prisma.user.findUnique({\r\n            where: { id: auth.user.id },\r\n            select: { email: true, profile: { select: { name: true } } },\r\n          })\r\n          const accountName = userInfo?.profile?.name || (userInfo?.email?.split(\"@\")[0] || \"UFriends User\")\r\n          const customerEmail = userInfo?.email || \"\"\r\n\r\n          const created = await paymentPointCreateVirtualAccount({ email: customerEmail, name: accountName })\r\n          accountNumber = created.accountNumber\r\n          bankName = created.bankName || bankName\r\n\r\n          await prisma.virtualAccount.upsert({\r\n            where: { userId: auth.user.id },\r\n            update: { accountNumber, bankName },\r\n            create: { userId: auth.user.id, accountNumber, bankName },\r\n          })\r\n          wasCreated = true\r\n        }\r\n\r\n        await prisma.auditLog\r\n          .create({\r\n            data: {\r\n              actorId: auth.user.id,\r\n              action: wasCreated\r\n                ? \"PAYMENTPOINT_VIRTUAL_ACCOUNT_CREATED_FOR_FUNDING\"\r\n                : \"PAYMENTPOINT_VIRTUAL_ACCOUNT_ACCESSED_FOR_FUNDING\",\r\n              resourceType: \"VirtualAccount\",\r\n              resourceId: accountNumber,\r\n              diffJson: { accountNumber, bankName, wasCreated, fundingReference: reference },\r\n            },\r\n          })\r\n          .catch(() => {})\r\n      } catch {\r\n        // Fallback: derive deterministic account number\r\n        accountNumber = deriveVirtualAccountNumber(auth.user.id)\r\n      }\r\n\r\n      const instructions = `Transfer â‚¦${amount.toLocaleString()} to your PaymentPoint virtual account ${accountNumber} at ${bankName}. Reference: ${reference}. Wallet credits after confirmation.`\r\n      return NextResponse.json({\r\n        ok: true,\r\n        provider: \"PaymentPoint\",\r\n        reference,\r\n        instructions,\r\n        virtualAccount: { accountNumber, bankName },\r\n      })\r\n    }\r\n\r\n    if (provider === \"bank-transfer\") {\r\n      // Fetch or derive virtual account details\r\n      let accountNumber: string | undefined\r\n      let bankName = \"Moniepoint Microfinance Bank\"\r\n      let wasCreated = false\r\n      try {\r\n        const va = await prisma.virtualAccount.findUnique({ where: { userId: auth.user.id } })\r\n        accountNumber = va?.accountNumber\r\n        bankName = va?.bankName || bankName\r\n        if (!accountNumber) {\r\n          // Create Monnify reserved account for bank transfer\r\n          const userInfo = await prisma.user.findUnique({\r\n            where: { id: auth.user.id },\r\n            select: { email: true, profile: { select: { name: true } } },\r\n          })\r\n          const accountName = userInfo?.profile?.name || (userInfo?.email?.split(\"@\")[0] || \"UFriends User\")\r\n          const customerName = accountName\r\n          const customerEmail = userInfo?.email || \"\"\r\n          const accountReference = `VA-${auth.user.id}`\r\n\r\n          const reserved = await monnifyCreateReservedAccount({\r\n            accountReference,\r\n            accountName,\r\n            customerName,\r\n            customerEmail,\r\n          })\r\n          accountNumber = reserved.accountNumber\r\n          bankName = reserved.bankName || bankName\r\n\r\n          await prisma.virtualAccount.upsert({\r\n            where: { userId: auth.user.id },\r\n            update: { accountNumber, bankName },\r\n            create: { userId: auth.user.id, accountNumber, bankName },\r\n          })\r\n          wasCreated = true\r\n        }\r\n\r\n        await prisma.auditLog.create({\r\n          data: {\r\n            actorId: auth.user.id,\r\n            action: wasCreated ? \"VIRTUAL_ACCOUNT_CREATED_FOR_FUNDING\" : \"VIRTUAL_ACCOUNT_ACCESSED_FOR_FUNDING\",\r\n            resourceType: \"VirtualAccount\",\r\n            resourceId: accountNumber,\r\n            diffJson: { accountNumber, bankName, wasCreated, fundingReference: reference },\r\n          },\r\n        })\r\n      } catch {}\r\n\r\n      // Prepare Monnify transaction init input\r\n      const userInfo = await prisma.user.findUnique({\r\n        where: { id: auth.user.id },\r\n        select: { email: true, profile: { select: { name: true } } },\r\n      })\r\n      const customerName = userInfo?.profile?.name || (userInfo?.email?.split(\"@\")[0] || \"UFriends User\")\r\n      const customerEmail = userInfo?.email || \"\"\r\n      const redirectUrl = `${process.env.NEXT_PUBLIC_APP_URL || \"http://localhost:3000\"}/dashboard/wallet`\r\n\r\n      const init = await monnifyInitTransaction({\r\n        amount,\r\n        customerName,\r\n        customerEmail,\r\n        redirectUrl,\r\n        paymentReference: reference,\r\n      })\r\n      return NextResponse.json({ ok: true, provider: \"Monnify\", reference, payment: init })\r\n    }\r\n\r\n    return NextResponse.json({ error: \"Unsupported provider\" }, { status: 400 })\r\n  } catch (err) {\r\n    return NextResponse.json({ error: \"Funding initiation failed\", detail: String(err) }, { status: 500 })\r\n  }\r\n}"],"names":[],"mappings":"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","debugId":null}}]
}