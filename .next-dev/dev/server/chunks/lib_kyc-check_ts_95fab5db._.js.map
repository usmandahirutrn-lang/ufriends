{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Downloads/ufriends%20version%201/lib/kyc-check.ts"],"sourcesContent":["import { prisma } from \"@/lib/db\"\r\nimport { NextResponse } from \"next/server\"\r\n\r\n/**\r\n * Checks if a user has an approved KYC.\r\n * Returns null if verified, or a NextResponse error if blocked.\r\n */\r\nexport async function ensureKyc(userId: string) {\r\n    const user = await prisma.user.findUnique({\r\n        where: { id: userId },\r\n        select: { isKycVerified: true } as any,\r\n    }) as any\r\n\r\n    // If already flagged in user model, we are good\r\n    if (user?.isKycVerified) {\r\n        return null\r\n    }\r\n\r\n    // Fallback: Check if there's an APPROVED kycRequest (in case flag is out of sync)\r\n    const approvedKyc = await prisma.kycRequest.findFirst({\r\n        where: { userId, status: \"APPROVED\" },\r\n    })\r\n\r\n    if (approvedKyc) {\r\n        // Self-heal: Update the flag if it was false but an approved request exists\r\n        await prisma.user.update({\r\n            where: { id: userId },\r\n            data: { isKycVerified: true } as any,\r\n        })\r\n        return null\r\n    }\r\n\r\n    return NextResponse.json(\r\n        {\r\n            error: \"KYC Required\",\r\n            message: \"Please complete your KYC verification to access this service.\",\r\n            code: \"KYC_REQUIRED\",\r\n        },\r\n        { status: 403 }\r\n    )\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAMO,eAAe,UAAU,MAAc;IAC1C,MAAM,OAAO,MAAM,qHAAM,CAAC,IAAI,CAAC,UAAU,CAAC;QACtC,OAAO;YAAE,IAAI;QAAO;QACpB,QAAQ;YAAE,eAAe;QAAK;IAClC;IAEA,gDAAgD;IAChD,IAAI,MAAM,eAAe;QACrB,OAAO;IACX;IAEA,kFAAkF;IAClF,MAAM,cAAc,MAAM,qHAAM,CAAC,UAAU,CAAC,SAAS,CAAC;QAClD,OAAO;YAAE;YAAQ,QAAQ;QAAW;IACxC;IAEA,IAAI,aAAa;QACb,4EAA4E;QAC5E,MAAM,qHAAM,CAAC,IAAI,CAAC,MAAM,CAAC;YACrB,OAAO;gBAAE,IAAI;YAAO;YACpB,MAAM;gBAAE,eAAe;YAAK;QAChC;QACA,OAAO;IACX;IAEA,OAAO,gJAAY,CAAC,IAAI,CACpB;QACI,OAAO;QACP,SAAS;QACT,MAAM;IACV,GACA;QAAE,QAAQ;IAAI;AAEtB","debugId":null}}]
}