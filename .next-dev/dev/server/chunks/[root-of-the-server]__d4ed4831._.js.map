{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Downloads/ufriends%20version%201/lib/db.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\"\n\nconst globalForPrisma = global as unknown as { prisma: PrismaClient | undefined }\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: [\"error\", \"warn\"],\n  })\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM;AAEC,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK;QAAC;QAAS;KAAO;AACxB;AAEF,wCAA2C,gBAAgB,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Downloads/ufriends%20version%201/lib/jwt.ts"],"sourcesContent":["import { SignJWT, jwtVerify, JWTPayload } from \"jose\";\n\nconst encoder = new TextEncoder();\n\nfunction getAccessSecret() {\n  const secret = process.env.JWT_SECRET || \"dev_access_secret\";\n  return encoder.encode(secret);\n}\n\nfunction getRefreshSecret() {\n  const secret = process.env.JWT_REFRESH_SECRET || \"dev_refresh_secret\";\n  return encoder.encode(secret);\n}\n\nfunction nowSeconds() {\n  return Math.floor(Date.now() / 1000);\n}\n\nexport type TokenPayload = {\n  sub: string; // user id\n  email: string;\n  role: string;\n  jti?: string; // token id for refresh\n};\n\nexport async function signAccessToken(payload: TokenPayload, expiresInSeconds = 15 * 60) {\n  return new SignJWT(payload as JWTPayload)\n    .setProtectedHeader({ alg: \"HS256\" })\n    .setIssuedAt()\n    .setExpirationTime(nowSeconds() + expiresInSeconds)\n    .sign(getAccessSecret());\n}\n\nexport async function signRefreshToken(payload: TokenPayload, expiresInSeconds = 7 * 24 * 60 * 60) {\n  return new SignJWT(payload as JWTPayload)\n    .setProtectedHeader({ alg: \"HS256\" })\n    .setIssuedAt()\n    .setExpirationTime(nowSeconds() + expiresInSeconds)\n    .sign(getRefreshSecret());\n}\n\nexport async function verifyAccessToken<T = TokenPayload>(token: string) {\n  const { payload } = await jwtVerify(token, getAccessSecret());\n  return payload as T;\n}\n\nexport async function verifyRefreshToken<T = TokenPayload>(token: string) {\n  const { payload } = await jwtVerify(token, getRefreshSecret());\n  return payload as T;\n}"],"names":[],"mappings":";;;;;;;;;;AAAA;AAAA;;AAEA,MAAM,UAAU,IAAI;AAEpB,SAAS;IACP,MAAM,SAAS,QAAQ,GAAG,CAAC,UAAU,IAAI;IACzC,OAAO,QAAQ,MAAM,CAAC;AACxB;AAEA,SAAS;IACP,MAAM,SAAS,QAAQ,GAAG,CAAC,kBAAkB,IAAI;IACjD,OAAO,QAAQ,MAAM,CAAC;AACxB;AAEA,SAAS;IACP,OAAO,KAAK,KAAK,CAAC,KAAK,GAAG,KAAK;AACjC;AASO,eAAe,gBAAgB,OAAqB,EAAE,mBAAmB,KAAK,EAAE;IACrF,OAAO,IAAI,kKAAO,CAAC,SAChB,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,WAAW,GACX,iBAAiB,CAAC,eAAe,kBACjC,IAAI,CAAC;AACV;AAEO,eAAe,iBAAiB,OAAqB,EAAE,mBAAmB,IAAI,KAAK,KAAK,EAAE;IAC/F,OAAO,IAAI,kKAAO,CAAC,SAChB,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,WAAW,GACX,iBAAiB,CAAC,eAAe,kBACjC,IAAI,CAAC;AACV;AAEO,eAAe,kBAAoC,KAAa;IACrE,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,sKAAS,EAAC,OAAO;IAC3C,OAAO;AACT;AAEO,eAAe,mBAAqC,KAAa;IACtE,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,sKAAS,EAAC,OAAO;IAC3C,OAAO;AACT","debugId":null}},
    {"offset": {"line": 273, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Downloads/ufriends%20version%201/lib/security.ts"],"sourcesContent":["import arcjet, { shield, validateEmail } from \"@arcjet/next\"\n\ntype AJInstance = ReturnType<typeof arcjet> | null\n\n// Create a shared Arcjet instance with common rules.\n// In development, ARCJET_KEY may be missing, so we fail open.\nexport const aj: AJInstance = process.env.ARCJET_KEY\n  ? arcjet({\n      key: process.env.ARCJET_KEY!,\n      rules: [\n        shield({ mode: \"LIVE\" }),\n      ],\n    })\n  : null\n\n// Email-validation instance for routes that need email context\nexport const ajWithEmail: AJInstance = process.env.ARCJET_KEY\n  ? arcjet({\n      key: process.env.ARCJET_KEY!,\n      rules: [\n        shield({ mode: \"LIVE\" }),\n        validateEmail({ mode: \"LIVE\", deny: [\"DISPOSABLE\", \"INVALID\", \"NO_MX_RECORDS\"] }),\n      ],\n    })\n  : null\n\nexport async function protect(req: Request, opts?: { email?: string }) {\n  if (!aj) return { allowed: true }\n  try {\n    const decision = await (opts?.email && ajWithEmail\n      ? (ajWithEmail as any).protect(req as any, { email: opts.email })\n      : (aj as any).protect(req as any))\n    if (decision?.isDenied?.()) return { allowed: false }\n    return { allowed: true }\n  } catch {\n    // Fail open in dev\n    return { allowed: true }\n  }\n}"],"names":[],"mappings":";;;;;;;;AAAA;AAAA;;AAMO,MAAM,KAAiB,QAAQ,GAAG,CAAC,UAAU,GAChD,IAAA,sKAAM,EAAC;IACL,KAAK,QAAQ,GAAG,CAAC,UAAU;IAC3B,OAAO;QACL,IAAA,2IAAM,EAAC;YAAE,MAAM;QAAO;KACvB;AACH,KACA;AAGG,MAAM,cAA0B,QAAQ,GAAG,CAAC,UAAU,GACzD,IAAA,sKAAM,EAAC;IACL,KAAK,QAAQ,GAAG,CAAC,UAAU;IAC3B,OAAO;QACL,IAAA,2IAAM,EAAC;YAAE,MAAM;QAAO;QACtB,IAAA,kJAAa,EAAC;YAAE,MAAM;YAAQ,MAAM;gBAAC;gBAAc;gBAAW;aAAgB;QAAC;KAChF;AACH,KACA;AAEG,eAAe,QAAQ,GAAY,EAAE,IAAyB;IACnE,IAAI,CAAC,IAAI,OAAO;QAAE,SAAS;IAAK;IAChC,IAAI;QACF,MAAM,WAAW,MAAM,CAAC,MAAM,SAAS,cACnC,AAAC,YAAoB,OAAO,CAAC,KAAY;YAAE,OAAO,KAAK,KAAK;QAAC,KAC7D,AAAC,GAAW,OAAO,CAAC,IAAW;QACnC,IAAI,UAAU,cAAc,OAAO;YAAE,SAAS;QAAM;QACpD,OAAO;YAAE,SAAS;QAAK;IACzB,EAAE,OAAM;QACN,mBAAmB;QACnB,OAAO;YAAE,SAAS;QAAK;IACzB;AACF","debugId":null}},
    {"offset": {"line": 339, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Downloads/ufriends%20version%201/lib/validation.ts"],"sourcesContent":["import { z } from \"zod\"\nimport { ZodXssSanitizer, ACTION_LEVELS } from \"zod-xss-sanitizer\"\n\n// Shared XSS sanitizer instance\nexport const sanitizer = ZodXssSanitizer.sanitizer({ actionLevel: ACTION_LEVELS.SANITIZE })\n\nexport function sanitizeEmail(input: string) {\n  return sanitizer.parse(z.string().trim().toLowerCase().email().parse(input))\n}\n\nexport function sanitizeString(input: string) {\n  return sanitizer.parse(z.string().trim().min(1).parse(input))\n}\n\nexport function sanitizePhone(input: string) {\n  const schema = z.string().trim().regex(/^\\+?[0-9]{10,15}$/i, { message: \"Invalid phone\" })\n  return sanitizer.parse(schema.parse(input))\n}\n\nexport function isValidUrl(input: string) {\n  const res = z.string().url().safeParse(input)\n  return res.success\n}"],"names":[],"mappings":";;;;;;;;;;;;AAAA;AACA;;;AAGO,MAAM,YAAY,8KAAe,CAAC,SAAS,CAAC;IAAE,aAAa,4KAAa,CAAC,QAAQ;AAAC;AAElF,SAAS,cAAc,KAAa;IACzC,OAAO,UAAU,KAAK,CAAC,yKAAC,CAAC,MAAM,GAAG,IAAI,GAAG,WAAW,GAAG,KAAK,GAAG,KAAK,CAAC;AACvE;AAEO,SAAS,eAAe,KAAa;IAC1C,OAAO,UAAU,KAAK,CAAC,yKAAC,CAAC,MAAM,GAAG,IAAI,GAAG,GAAG,CAAC,GAAG,KAAK,CAAC;AACxD;AAEO,SAAS,cAAc,KAAa;IACzC,MAAM,SAAS,yKAAC,CAAC,MAAM,GAAG,IAAI,GAAG,KAAK,CAAC,sBAAsB;QAAE,SAAS;IAAgB;IACxF,OAAO,UAAU,KAAK,CAAC,OAAO,KAAK,CAAC;AACtC;AAEO,SAAS,WAAW,KAAa;IACtC,MAAM,MAAM,yKAAC,CAAC,MAAM,GAAG,GAAG,GAAG,SAAS,CAAC;IACvC,OAAO,IAAI,OAAO;AACpB","debugId":null}},
    {"offset": {"line": 378, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Downloads/ufriends%20version%201/lib/auth.ts"],"sourcesContent":["import NextAuth from \"next-auth\"\nimport type { NextAuthOptions } from \"next-auth\"\nimport Credentials from \"next-auth/providers/credentials\"\nimport { prisma } from \"@/lib/db\"\nimport bcrypt from \"bcryptjs\"\nimport { protect } from \"@/lib/security\"\nimport Joi from \"joi\"\nimport { sanitizer } from \"@/lib/validation\"\n\nconst isProd = process.env.NODE_ENV === \"production\"\n\nexport const authOptions: NextAuthOptions = {\n  session: { strategy: \"jwt\" },\n  providers: [\n    Credentials({\n      name: \"Credentials\",\n      credentials: {\n        email: { label: \"Email\", type: \"email\" },\n        password: { label: \"Password\", type: \"password\" },\n      },\n      async authorize(credentials, req) {\n        console.log(\"AUTH DEBUG: authorize called with\", { email: credentials?.email })\n        // Basic input validation with Joi\n        const schema = Joi.object({\n          // Allow non-public TLDs (e.g., .local) in development; enforce strict in production\n          email: isProd\n            ? Joi.string().email().required()\n            : Joi.string().email({ tlds: { allow: false } }).required(),\n          password: Joi.string().min(6).required(),\n        })\n        const { error, value } = schema.validate({\n          email: credentials?.email,\n          password: credentials?.password,\n        })\n        if (error) {\n          console.log(\"AUTH DEBUG: Joi validation error\", error)\n          return null\n        }\n\n        // Sanitize email using shared sanitizer\n        const safeEmail = sanitizer.parse(value.email.trim().toLowerCase())\n\n        // Centralized protection: Shield/email validation handled by shared helper\n        try {\n          const sec = await protect(req as any, { email: safeEmail })\n          if (!sec.allowed) {\n            console.log(\"AUTH DEBUG: Protected by Arcjet/Security\")\n            return null\n          }\n        } catch {\n          // Fail open to avoid login lockouts if Arcjet fails\n        }\n\n        // Credentials auth\n        const user = await prisma.user.findUnique({ where: { email: safeEmail } })\n        if (!user) {\n          console.log(\"AUTH DEBUG: User not found\", safeEmail)\n          return null\n        }\n        const ok = await bcrypt.compare(value.password, user.passwordHash)\n        if (!ok) {\n          console.log(\"AUTH DEBUG: Password mismatch for\", safeEmail)\n          return null\n        }\n        console.log(\"AUTH DEBUG: Auth successful for\", safeEmail)\n        return { id: user.id, email: user.email, role: user.role }\n      },\n    }),\n  ],\n  callbacks: {\n    async jwt({ token, user }) {\n      if (user) {\n        ; (token as any).id = (user as any).id\n          ; (token as any).role = (user as any).role\n      }\n      return token\n    },\n    async session({ session, token }) {\n      if (session.user) {\n        ; (session.user as any).id = (token as any).id\n          ; (session.user as any).role = (token as any).role\n      }\n      return session\n    },\n  },\n}"],"names":[],"mappings":";;;;AAEA;AACA;AACA;AACA;AACA;AACA;;;;;;;AAEA,MAAM,SAAS,oDAAyB;AAEjC,MAAM,cAA+B;IAC1C,SAAS;QAAE,UAAU;IAAM;IAC3B,WAAW;QACT,IAAA,qKAAW,EAAC;YACV,MAAM;YACN,aAAa;gBACX,OAAO;oBAAE,OAAO;oBAAS,MAAM;gBAAQ;gBACvC,UAAU;oBAAE,OAAO;oBAAY,MAAM;gBAAW;YAClD;YACA,MAAM,WAAU,WAAW,EAAE,GAAG;gBAC9B,QAAQ,GAAG,CAAC,qCAAqC;oBAAE,OAAO,aAAa;gBAAM;gBAC7E,kCAAkC;gBAClC,MAAM,SAAS,gJAAG,CAAC,MAAM,CAAC;oBACxB,oFAAoF;oBACpF,OAAO,sCACH,0BACA,gJAAG,CAAC,MAAM,GAAG,KAAK,CAAC;wBAAE,MAAM;4BAAE,OAAO;wBAAM;oBAAE,GAAG,QAAQ;oBAC3D,UAAU,gJAAG,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG,QAAQ;gBACxC;gBACA,MAAM,EAAE,KAAK,EAAE,KAAK,EAAE,GAAG,OAAO,QAAQ,CAAC;oBACvC,OAAO,aAAa;oBACpB,UAAU,aAAa;gBACzB;gBACA,IAAI,OAAO;oBACT,QAAQ,GAAG,CAAC,oCAAoC;oBAChD,OAAO;gBACT;gBAEA,wCAAwC;gBACxC,MAAM,YAAY,gIAAS,CAAC,KAAK,CAAC,MAAM,KAAK,CAAC,IAAI,GAAG,WAAW;gBAEhE,2EAA2E;gBAC3E,IAAI;oBACF,MAAM,MAAM,MAAM,IAAA,4HAAO,EAAC,KAAY;wBAAE,OAAO;oBAAU;oBACzD,IAAI,CAAC,IAAI,OAAO,EAAE;wBAChB,QAAQ,GAAG,CAAC;wBACZ,OAAO;oBACT;gBACF,EAAE,OAAM;gBACN,oDAAoD;gBACtD;gBAEA,mBAAmB;gBACnB,MAAM,OAAO,MAAM,qHAAM,CAAC,IAAI,CAAC,UAAU,CAAC;oBAAE,OAAO;wBAAE,OAAO;oBAAU;gBAAE;gBACxE,IAAI,CAAC,MAAM;oBACT,QAAQ,GAAG,CAAC,8BAA8B;oBAC1C,OAAO;gBACT;gBACA,MAAM,KAAK,MAAM,8IAAM,CAAC,OAAO,CAAC,MAAM,QAAQ,EAAE,KAAK,YAAY;gBACjE,IAAI,CAAC,IAAI;oBACP,QAAQ,GAAG,CAAC,qCAAqC;oBACjD,OAAO;gBACT;gBACA,QAAQ,GAAG,CAAC,mCAAmC;gBAC/C,OAAO;oBAAE,IAAI,KAAK,EAAE;oBAAE,OAAO,KAAK,KAAK;oBAAE,MAAM,KAAK,IAAI;gBAAC;YAC3D;QACF;KACD;IACD,WAAW;QACT,MAAM,KAAI,EAAE,KAAK,EAAE,IAAI,EAAE;YACvB,IAAI,MAAM;;gBACL,MAAc,EAAE,GAAG,AAAC,KAAa,EAAE;gBACjC,MAAc,IAAI,GAAG,AAAC,KAAa,IAAI;YAC9C;YACA,OAAO;QACT;QACA,MAAM,SAAQ,EAAE,OAAO,EAAE,KAAK,EAAE;YAC9B,IAAI,QAAQ,IAAI,EAAE;;gBACb,QAAQ,IAAI,CAAS,EAAE,GAAG,AAAC,MAAc,EAAE;gBACzC,QAAQ,IAAI,CAAS,IAAI,GAAG,AAAC,MAAc,IAAI;YACtD;YACA,OAAO;QACT;IACF;AACF","debugId":null}},
    {"offset": {"line": 495, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Downloads/ufriends%20version%201/lib/jwt-auth.ts"],"sourcesContent":["import { verifyAccessToken } from \"./jwt\"\nimport { getServerSession } from \"next-auth\"\nimport { authOptions } from \"@/lib/auth\"\n\nexport type AuthUser = { id: string; email?: string | null; role?: string | null }\n\nexport async function getAuthUser(req: Request): Promise<AuthUser | null> {\n  // Prefer Authorization: Bearer access token\n  const authHeader = (req as any).headers?.get?.(\"authorization\") || \"\"\n  const [, token] = authHeader.split(\" \")\n  if (authHeader.toLowerCase().startsWith(\"bearer \") && token) {\n    try {\n      const payload: any = await verifyAccessToken(token)\n      return { id: payload.sub, email: payload.email, role: payload.role }\n    } catch {}\n  }\n\n  // Fallback to NextAuth session\n  try {\n    const session = await getServerSession(authOptions)\n    if (session?.user?.id) {\n      return { id: (session.user as any).id, email: session.user.email, role: (session.user as any).role }\n    }\n  } catch {}\n\n  return null\n}"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAIO,eAAe,YAAY,GAAY;IAC5C,4CAA4C;IAC5C,MAAM,aAAa,AAAC,IAAY,OAAO,EAAE,MAAM,oBAAoB;IACnE,MAAM,GAAG,MAAM,GAAG,WAAW,KAAK,CAAC;IACnC,IAAI,WAAW,WAAW,GAAG,UAAU,CAAC,cAAc,OAAO;QAC3D,IAAI;YACF,MAAM,UAAe,MAAM,IAAA,iIAAiB,EAAC;YAC7C,OAAO;gBAAE,IAAI,QAAQ,GAAG;gBAAE,OAAO,QAAQ,KAAK;gBAAE,MAAM,QAAQ,IAAI;YAAC;QACrE,EAAE,OAAM,CAAC;IACX;IAEA,+BAA+B;IAC/B,IAAI;QACF,MAAM,UAAU,MAAM,IAAA,2JAAgB,EAAC,4HAAW;QAClD,IAAI,SAAS,MAAM,IAAI;YACrB,OAAO;gBAAE,IAAI,AAAC,QAAQ,IAAI,CAAS,EAAE;gBAAE,OAAO,QAAQ,IAAI,CAAC,KAAK;gBAAE,MAAM,AAAC,QAAQ,IAAI,CAAS,IAAI;YAAC;QACrG;IACF,EAAE,OAAM,CAAC;IAET,OAAO;AACT","debugId":null}},
    {"offset": {"line": 536, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Downloads/ufriends%20version%201/lib/require-auth.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { getAuthUser, AuthUser } from \"@/lib/jwt-auth\"\n\nexport type RequireAuthOptions = {\n  roles?: Array<string>\n}\n\nexport type RequireAuthResult = {\n  ok: true\n  user: AuthUser\n} | {\n  ok: false\n  response: NextResponse\n}\n\nexport async function requireAuth(req: Request, options: RequireAuthOptions = {}): Promise<RequireAuthResult> {\n  const user = await getAuthUser(req)\n  if (!user?.id) {\n    return { ok: false, response: NextResponse.json({ error: \"Unauthorized\" }, { status: 401 }) }\n  }\n  if (options.roles && user.role && !options.roles.includes(user.role)) {\n    return { ok: false, response: NextResponse.json({ error: \"Forbidden\" }, { status: 403 }) }\n  }\n  return { ok: true, user }\n}"],"names":[],"mappings":";;;;AAAA;AACA;;;AAcO,eAAe,YAAY,GAAY,EAAE,UAA8B,CAAC,CAAC;IAC9E,MAAM,OAAO,MAAM,IAAA,mIAAW,EAAC;IAC/B,IAAI,CAAC,MAAM,IAAI;QACb,OAAO;YAAE,IAAI;YAAO,UAAU,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QAAG;IAC9F;IACA,IAAI,QAAQ,KAAK,IAAI,KAAK,IAAI,IAAI,CAAC,QAAQ,KAAK,CAAC,QAAQ,CAAC,KAAK,IAAI,GAAG;QACpE,OAAO;YAAE,IAAI;YAAO,UAAU,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAY,GAAG;gBAAE,QAAQ;YAAI;QAAG;IAC3F;IACA,OAAO;QAAE,IAAI;QAAM;IAAK;AAC1B","debugId":null}},
    {"offset": {"line": 575, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Downloads/ufriends%20version%201/app/api/admin/reports/metrics/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { prisma } from \"@/lib/db\"\nimport { requireAuth } from \"@/lib/require-auth\"\nimport { protect } from \"@/lib/security\"\n\n// GET /api/admin/reports/metrics?from=YYYY-MM-DD&to=YYYY-MM-DD&limit=5\n// Aggregates revenue, top services, top users, and active users over time\nexport async function GET(req: NextRequest) {\n  try {\n    const auth = await requireAuth(req, { roles: [\"ADMIN\"] })\n    if (!auth.ok) return auth.response\n\n    const sec = await protect(req as any)\n    if (!sec.allowed) {\n      return NextResponse.json({ error: \"Forbidden\" }, { status: 403 })\n    }\n\n    const { searchParams } = new URL(req.url)\n    const fromStr = searchParams.get(\"from\") || undefined\n    const toStr = searchParams.get(\"to\") || undefined\n    const topLimit = Math.min(20, Math.max(1, Number(searchParams.get(\"limit\") || 5)))\n\n    const now = new Date()\n    const defaultFrom = new Date(now)\n    defaultFrom.setMonth(defaultFrom.getMonth() - 6)\n    const from = fromStr ? new Date(fromStr) : defaultFrom\n    const to = toStr ? new Date(`${toStr}T23:59:59.999Z`) : now\n\n    const txs = await prisma.transaction.findMany({\n      where: {\n        createdAt: { gte: from, lte: to },\n        type: \"SERVICE_PURCHASE\",\n      },\n      select: { amount: true, status: true, userId: true, createdAt: true, meta: true },\n      orderBy: { createdAt: \"asc\" },\n      take: 10000,\n    })\n\n    // Revenue/profit over time (monthly buckets)\n    const monthKey = (d: Date) => {\n      const y = d.getFullYear()\n      const m = d.getMonth()\n      const label = d.toLocaleString(\"en-US\", { month: \"short\" }) + \" \" + y\n      return { key: `${y}-${m}`, label }\n    }\n\n    const revenueBuckets: Record<string, { month: string; revenue: number; profit: number }> = {}\n    const ASSUMED_MARGIN = 0.15 // Profit assumed until cost tracking is implemented\n\n    let totalRevenue = 0\n    let totalRequests = 0\n    const activeUsersSet = new Set<string>()\n\n    const svcAgg: Record<string, { service: string; revenue: number; requests: number }> = {}\n    const userAgg: Record<string, { userId: string; revenue: number; requests: number }> = {}\n    const monthlyActiveUsers: Record<string, Set<string>> = {}\n\n    for (const tx of txs) {\n      totalRequests += 1\n      const mk = monthKey(tx.createdAt)\n      monthlyActiveUsers[mk.key] = monthlyActiveUsers[mk.key] || new Set<string>()\n      monthlyActiveUsers[mk.key].add(tx.userId)\n      activeUsersSet.add(tx.userId)\n\n      // Aggregate services by meta.serviceId/subServiceId\n      const meta = (tx.meta || {}) as any\n      const serviceId: string = meta?.serviceId || \"unknown\"\n      const subServiceId: string = meta?.subServiceId || meta?.action || \"\"\n      const label = subServiceId ? `${serviceId}:${subServiceId}` : serviceId\n      const pretty = subServiceId ? `${serviceId} â€¢ ${subServiceId}` : serviceId\n      svcAgg[label] = svcAgg[label] || { service: pretty, revenue: 0, requests: 0 }\n      svcAgg[label].requests += 1\n\n      // User aggregates\n      userAgg[tx.userId] = userAgg[tx.userId] || { userId: tx.userId, revenue: 0, requests: 0 }\n      userAgg[tx.userId].requests += 1\n\n      if (tx.status === \"SUCCESS\") {\n        const amt = Number(tx.amount || 0)\n        totalRevenue += amt\n        svcAgg[label].revenue += amt\n        userAgg[tx.userId].revenue += amt\n\n        revenueBuckets[mk.key] = revenueBuckets[mk.key] || { month: mk.label, revenue: 0, profit: 0 }\n        revenueBuckets[mk.key].revenue += amt\n        revenueBuckets[mk.key].profit += amt * ASSUMED_MARGIN\n      }\n    }\n\n    const revenueOverTime = Object.values(revenueBuckets).sort((a, b) => a.month.localeCompare(b.month))\n\n    const topServices = Object.values(svcAgg)\n      .sort((a, b) => b.revenue - a.revenue)\n      .slice(0, topLimit)\n\n    const topUserIds = Object.keys(userAgg)\n      .sort((a, b) => userAgg[b].revenue - userAgg[a].revenue)\n      .slice(0, topLimit)\n\n    const users = await prisma.user.findMany({\n      where: { id: { in: topUserIds } },\n      select: { id: true, email: true, profile: { select: { name: true } } },\n    })\n    const userMap = new Map(users.map((u) => [u.id, u]))\n    const topUsers = topUserIds.map((uid) => {\n      const u = userMap.get(uid)\n      return {\n        name: u?.profile?.name || \"Unknown\",\n        email: u?.email || \"\",\n        requests: userAgg[uid].requests,\n        spent: userAgg[uid].revenue,\n        profit: userAgg[uid].revenue * ASSUMED_MARGIN,\n      }\n    })\n\n    // Monthly active users\n    const userGrowth = Object.entries(monthlyActiveUsers)\n      .map(([key, set]) => {\n        const [y, m] = key.split(\"-\")\n        const d = new Date(Number(y), Number(m), 1)\n        return { month: d.toLocaleString(\"en-US\", { month: \"short\" }) + \" \" + d.getFullYear(), users: set.size }\n      })\n      .sort((a, b) => a.month.localeCompare(b.month))\n\n    const profitMargin = totalRevenue > 0 ? (ASSUMED_MARGIN * 100) : 0\n    const summary = {\n      totalRevenue,\n      totalRequests,\n      profitMargin: Number(profitMargin.toFixed(2)),\n      activeUsers: activeUsersSet.size,\n    }\n\n    return NextResponse.json({\n      ok: true,\n      summary,\n      revenueOverTime,\n      topServices,\n      topUsers,\n      userGrowth,\n    })\n  } catch (err) {\n    return NextResponse.json({ error: \"Failed to compute metrics\", detail: String(err) }, { status: 500 })\n  }\n}"],"names":[],"mappings":"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","debugId":null}}]
}